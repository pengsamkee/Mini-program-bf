"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var interface_1 = require("./../../../api/app/interface");
var ConfirmMeal = (function () {
    function ConfirmMeal() {
        this.data = {
            mealId: 20646,
            imgH: null,
            imgKey: null,
            imgW: null,
            mealDate: null,
            mealType: null,
            taggs: [],
            unitArr: [],
            showPicker: false,
            columns: [],
            pickerIndex: null,
            chooseUnitIndex: '',
            totalEnergy: 0,
        };
    }
    ConfirmMeal.prototype.onLoad = function (options) {
        var _this = this;
        var _a = JSON.parse(options.jsonMealInfo), imgH = _a.imgH, imgKey = _a.imgKey, imgW = _a.imgW, mealDate = _a.mealDate, mealType = _a.mealType, taggs = _a.taggs;
        this.setData({
            imgH: imgH,
            imgKey: imgKey,
            imgW: imgW,
            mealDate: mealDate,
            mealType: mealType,
            taggs: taggs,
        }, function () {
            _this.getFoodUnitOptionList();
        });
    };
    ConfirmMeal.prototype.handleShowPicker = function (e) {
        var pickerIndex = e.currentTarget.dataset.pickerIndex;
        if (pickerIndex === 'person') {
            var columns = [1, 2, 3, 4, 5, 6];
        }
        else {
            var columns = this.data.unitArr[pickerIndex].unitOption.map(function (item) { return item.unitName; });
        }
        this.setData({
            columns: columns,
            pickerIndex: pickerIndex,
            showPicker: true,
            showPopup: false
        });
    };
    ConfirmMeal.prototype.onConfirm = function () {
        this.setData({ showPicker: false, showPopup: true });
    };
    ConfirmMeal.prototype.onChange = function (e) {
        var _this = this;
        var chooseUnitIndex = e.detail.index;
        this.data.unitArr[this.data.pickerIndex].chooseUnitIndex = chooseUnitIndex;
        this.setData({ unitArr: this.data.unitArr }, function () {
            _this.totalEnergy();
        });
    };
    ConfirmMeal.prototype.getFoodUnitOptionList = function () {
        var _this = this;
        var req = this.data.taggs.map(function (item) {
            return {
                foodId: item.foodId,
                foodType: item.foodType
            };
        });
        console.log(8888, this.data.taggs);
        interface_1.default.getFoodUnitOptionList({ foodUnitOptionList: req }).then(function (res) {
            res.map(function (item) {
                item.chooseUnitIndex = 0;
                item.amount = 1;
            });
            var unitArr = res.slice();
            _this.setData({ unitArr: unitArr }, function () {
                _this.totalEnergy();
            });
        }).catch(function (err) {
            wx.showToast({ title: err.msg, icon: 'none' });
        });
    };
    ConfirmMeal.prototype.handleAmountInput = function (e) {
        var _this = this;
        var inputIndex = e.currentTarget.dataset.inputIndex;
        var value = e.detail.value;
        value = parseInt(value);
        this.data.unitArr[inputIndex].amount = value;
        this.setData({ unitArr: this.data.unitArr }, function () {
            _this.totalEnergy();
        });
    };
    ConfirmMeal.prototype.handleAmountInputFocus = function (e) {
        var inputIndex = e.currentTarget.dataset.inputIndex;
        var item = this.data.unitArr[inputIndex];
        item.focusAmount = item.amount;
        item.amount = 0;
        this.setData({ unitArr: this.data.unitArr });
    };
    ConfirmMeal.prototype.handleAmountInputBlur = function (e) {
        var inputIndex = e.currentTarget.dataset.inputIndex;
        var item = this.data.unitArr[inputIndex];
        if (item.amount == 0) {
            debugger;
            item.amount = item.focusAmount;
            this.setData({ unitArr: this.data.unitArr });
        }
    };
    ConfirmMeal.prototype.totalEnergy = function () {
        var unitArr = this.data.unitArr;
        var totalEnergy = unitArr.reduce(function (pre, next) {
            return next.amount / 100 * next.unitOption[next.chooseUnitIndex].energy + pre;
        }, 0);
        totalEnergy = Math.round(totalEnergy);
        this.setData({ totalEnergy: totalEnergy });
    };
    ConfirmMeal.prototype.handleGoWeightReferencePage = function () {
        wx.navigateTo({ url: './../weightReference/index' });
    };
    ConfirmMeal.prototype.createMealLog = function () {
        var _this = this;
        var _a = this.data, mealDate = _a.mealDate, mealType = _a.mealType, imgKey = _a.imgKey, imgW = _a.imgW, imgH = _a.imgH, taggs = _a.taggs;
        taggs.map(function (item, index) {
            var chooseUnitItem = _this.data.unitArr[index];
            item.inputType = 1;
            console.log(88, _this.data.unitArr);
            item.amount = chooseUnitItem.amount;
            item.unitId = chooseUnitItem.unitOption[chooseUnitItem.chooseUnitIndex].unitId;
            item.recognitionResults = item.resultList.slice();
            delete item.resultList;
            delete item.selectedPos;
        });
        debugger;
        var req = {
            mealDate: mealDate,
            mealType: mealType,
            imgKey: imgKey,
            imgW: imgW,
            imgH: imgH,
            foodInfoList: taggs
        };
        wx.showLoading({ title: '加载中...' });
        interface_1.default.createMealLog(req).then(function (res) {
            wx.hideLoading();
            wx.showToast({ title: '食物记录成功' });
            setTimeout(function () {
                wx.switchTab({ url: '/pages/home/index' });
            }, 1450);
        }).catch(function (err) {
            console.log(122, err);
        });
    };
    return ConfirmMeal;
}());
Page(new ConfirmMeal());
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLDBEQUFtRDtBQUVuRDtJQUFBO1FBRVcsU0FBSSxHQUFFO1lBQ1QsTUFBTSxFQUFFLEtBQUs7WUFDYixJQUFJLEVBQUMsSUFBSTtZQUNULE1BQU0sRUFBQyxJQUFJO1lBQ1gsSUFBSSxFQUFDLElBQUk7WUFDVCxRQUFRLEVBQUMsSUFBSTtZQUNiLFFBQVEsRUFBQyxJQUFJO1lBQ2IsS0FBSyxFQUFDLEVBQUU7WUFDUixPQUFPLEVBQUMsRUFBRTtZQUNWLFVBQVUsRUFBQyxLQUFLO1lBQ2hCLE9BQU8sRUFBQyxFQUFFO1lBQ1YsV0FBVyxFQUFDLElBQUk7WUFDaEIsZUFBZSxFQUFDLEVBQUU7WUFHbEIsV0FBVyxFQUFDLENBQUM7U0FDaEIsQ0FBQTtJQXNKTCxDQUFDO0lBckpVLDRCQUFNLEdBQWIsVUFBYyxPQUFPO1FBQXJCLGlCQVlDO1FBWE8sSUFBQSxxQ0FBNkUsRUFBNUUsY0FBSSxFQUFDLGtCQUFNLEVBQUMsY0FBSSxFQUFDLHNCQUFRLEVBQUMsc0JBQVEsRUFBQyxnQkFBeUMsQ0FBQztRQUNqRixJQUFZLENBQUMsT0FBTyxDQUFDO1lBQ2xCLElBQUksTUFBQTtZQUNKLE1BQU0sUUFBQTtZQUNOLElBQUksTUFBQTtZQUNKLFFBQVEsVUFBQTtZQUNSLFFBQVEsVUFBQTtZQUNSLEtBQUssT0FBQTtTQUNSLEVBQUM7WUFDRSxLQUFJLENBQUMscUJBQXFCLEVBQUUsQ0FBQztRQUNqQyxDQUFDLENBQUMsQ0FBQTtJQUNOLENBQUM7SUFJTSxzQ0FBZ0IsR0FBdkIsVUFBd0IsQ0FBSztRQUN6QixJQUFNLFdBQVcsR0FBRyxDQUFDLENBQUMsYUFBYSxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUM7UUFDeEQsSUFBRyxXQUFXLEtBQUcsUUFBUSxFQUFDO1lBQ3RCLElBQU0sT0FBTyxHQUFHLENBQUMsQ0FBQyxFQUFDLENBQUMsRUFB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UUFBQyxDQUFDO1lBQy9DLE9BQU8sSUFBSSxDQUFDLFVBQVUsQ0FBQztZQUN2QixPQUFPLElBQUksQ0FBQyxXQUFXLENBQUM7UUFDNUIsQ0FBQyxDQUFDLENBQUM7UUFDSCxRQUFRLENBQUE7UUFDUixJQUFJLEdBQUcsR0FBRztZQUNOLFFBQVEsVUFBQTtZQUNSLFFBQVEsVUFBQTtZQUNSLE1BQU0sUUFBQTtZQUNOLElBQUksTUFBQTtZQUNKLElBQUksTUFBQTtZQUNKLFlBQVksRUFBQyxLQUFLO1NBQ3JCLENBQUE7UUFDRCxFQUFFLENBQUMsV0FBVyxDQUFDLEVBQUcsS0FBSyxFQUFFLFFBQVEsRUFBRSxDQUFDLENBQUM7UUFDckMsbUJBQU8sQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQUEsR0FBRztZQUMvQixFQUFFLENBQUMsV0FBVyxFQUFFLENBQUM7WUFDakIsRUFBRSxDQUFDLFNBQVMsQ0FBQyxFQUFDLEtBQUssRUFBQyxRQUFRLEVBQUMsQ0FBQyxDQUFBO1lBQzlCLFVBQVUsQ0FBQztnQkFDUCxFQUFFLENBQUMsU0FBUyxDQUFDLEVBQUMsR0FBRyxFQUFFLG1CQUFtQixFQUFDLENBQUMsQ0FBQztZQUM3QyxDQUFDLEVBQUMsSUFBSSxDQUFDLENBQUE7UUFDWCxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsVUFBQSxHQUFHO1lBQ1IsT0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUMsR0FBRyxDQUFDLENBQUE7UUFDeEIsQ0FBQyxDQUFDLENBQUE7SUFDTixDQUFDO0lBRUwsa0JBQUM7QUFBRCxDQUFDLEFBeEtELElBd0tDO0FBRUQsSUFBSSxDQUFDLElBQUksV0FBVyxFQUFFLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCByZXF1ZXN0IGZyb20gJy4vLi4vLi4vLi4vYXBpL2FwcC9pbnRlcmZhY2UnO1xuXG5jbGFzcyBDb25maXJtTWVhbCB7XG5cbiAgICBwdWJsaWMgZGF0YT0ge1xuICAgICAgICBtZWFsSWQ6IDIwNjQ2LFxuICAgICAgICBpbWdIOm51bGwsXG4gICAgICAgIGltZ0tleTpudWxsLFxuICAgICAgICBpbWdXOm51bGwsXG4gICAgICAgIG1lYWxEYXRlOm51bGwsXG4gICAgICAgIG1lYWxUeXBlOm51bGwsXG4gICAgICAgIHRhZ2dzOltdLFxuICAgICAgICB1bml0QXJyOltdLFxuICAgICAgICBzaG93UGlja2VyOmZhbHNlLFxuICAgICAgICBjb2x1bW5zOltdLFxuICAgICAgICBwaWNrZXJJbmRleDpudWxsLFxuICAgICAgICBjaG9vc2VVbml0SW5kZXg6JycsXG4gICAgICAgIC8vIHBlcnNvbnM6WyfmiJHoh6rlt7Hni6zoh6rkuIDkuronLCcy5Lq655So6aSQJywnM+S6uueUqOmkkCcsJzTkurrnlKjppJAnLCc15Lq655So6aSQJywnNuS6uueUqOmkkCddLFxuICAgICAgICAvLyBjaG9vc2VQZXJzb25OdW1JbmRleDowLFxuICAgICAgICB0b3RhbEVuZXJneTowLFxuICAgIH1cbiAgICBwdWJsaWMgb25Mb2FkKG9wdGlvbnMpe1xuICAgICAgICBsZXQge2ltZ0gsaW1nS2V5LGltZ1csbWVhbERhdGUsbWVhbFR5cGUsdGFnZ3N9ID0gSlNPTi5wYXJzZShvcHRpb25zLmpzb25NZWFsSW5mbyk7XG4gICAgICAgICh0aGlzIGFzIGFueSkuc2V0RGF0YSh7XG4gICAgICAgICAgICBpbWdILFxuICAgICAgICAgICAgaW1nS2V5LFxuICAgICAgICAgICAgaW1nVyxcbiAgICAgICAgICAgIG1lYWxEYXRlLFxuICAgICAgICAgICAgbWVhbFR5cGUsXG4gICAgICAgICAgICB0YWdncyxcbiAgICAgICAgfSwoKT0+e1xuICAgICAgICAgICAgdGhpcy5nZXRGb29kVW5pdE9wdGlvbkxpc3QoKTtcbiAgICAgICAgfSlcbiAgICB9XG4gICAgIC8qKlxuICAgICAqIOWxleekunBpY2tlcu+8jOmAieaLqemjn+eJqeWNleS9jVxuICAgICAqL1xuICAgIHB1YmxpYyBoYW5kbGVTaG93UGlja2VyKGU6YW55KXtcbiAgICAgICAgY29uc3QgcGlja2VySW5kZXggPSBlLmN1cnJlbnRUYXJnZXQuZGF0YXNldC5waWNrZXJJbmRleDtcbiAgICAgICAgaWYocGlja2VySW5kZXg9PT0ncGVyc29uJyl7IC8v5YWx5pyJ5Yeg5Liq5Lq66aOf55SoXG4gICAgICAgICAgICBjb25zdCBjb2x1bW5zID0gWzEsMiwzLDQsNSw2XVxuICAgICAgICB9ZWxzZXtcbiAgICAgICAgICAgIGNvbnN0IGNvbHVtbnMgPSB0aGlzLmRhdGEudW5pdEFycltwaWNrZXJJbmRleF0udW5pdE9wdGlvbi5tYXAoaXRlbT0+aXRlbS51bml0TmFtZSlcbiAgICAgICAgfVxuICAgICAgICAodGhpcyBhcyBhbnkpLnNldERhdGEoe1xuICAgICAgICAgICAgY29sdW1uczpjb2x1bW5zLFxuICAgICAgICAgICAgcGlja2VySW5kZXg6cGlja2VySW5kZXgsXG4gICAgICAgICAgICBzaG93UGlja2VyOnRydWUsXG4gICAgICAgICAgICBzaG93UG9wdXA6ZmFsc2VcbiAgICAgICAgfSlcbiAgICB9XG4gICAgcHVibGljIG9uQ29uZmlybSgpe1xuICAgICAgICAodGhpcyBhcyBhbnkpLnNldERhdGEoe3Nob3dQaWNrZXI6ZmFsc2Usc2hvd1BvcHVwOnRydWV9KVxuICAgIH1cbiAgICBwdWJsaWMgb25DaGFuZ2UoZTphbnkpe1xuICAgICAgICBjb25zdCBjaG9vc2VVbml0SW5kZXg6bnVtYmVyID0gZS5kZXRhaWwuaW5kZXg7XG4gICAgICAgIC8vIGlmKHRoaXMuZGF0YS5waWNrZXJJbmRleD09PSdwZXJzb24nKXtcbiAgICAgICAgLy8gICAgICh0aGlzIGFzIGFueSkuc2V0RGF0YSh7Y2hvb3NlUGVyc29uTnVtSW5kZXggOiBjaG9vc2VVbml0SW5kZXh9KVxuICAgICAgICAvLyB9ZWxzZXtcbiAgICAgICAgICAgIHRoaXMuZGF0YS51bml0QXJyW3RoaXMuZGF0YS5waWNrZXJJbmRleF0uY2hvb3NlVW5pdEluZGV4ID0gY2hvb3NlVW5pdEluZGV4O1xuICAgICAgICAgICAgKHRoaXMgYXMgYW55KS5zZXREYXRhKHt1bml0QXJyOnRoaXMuZGF0YS51bml0QXJyfSwoKT0+e1xuICAgICAgICAgICAgICAgIHRoaXMudG90YWxFbmVyZ3koKVxuICAgICAgICAgICAgfSlcbiAgICAgICAgLy8gfVxuICAgIH1cbiAgICAvKipcbiAgICAgKiDor7fmsYLmiYDmnInljZXkvY3vvIzku6XkvptwaWNrZXLkvb/nlKhcbiAgICAgKi9cbiAgICBwdWJsaWMgZ2V0Rm9vZFVuaXRPcHRpb25MaXN0KCl7XG4gICAgICAgIGNvbnN0IHJlcSA9IHRoaXMuZGF0YS50YWdncy5tYXAoaXRlbT0+e1xuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICBmb29kSWQ6aXRlbS5mb29kSWQsXG4gICAgICAgICAgICAgICAgZm9vZFR5cGU6aXRlbS5mb29kVHlwZVxuICAgICAgICAgICAgfVxuICAgICAgICB9KVxuICAgICAgICBjb25zb2xlLmxvZyg4ODg4LHRoaXMuZGF0YS50YWdncylcbiAgICAgICAgcmVxdWVzdC5nZXRGb29kVW5pdE9wdGlvbkxpc3Qoe2Zvb2RVbml0T3B0aW9uTGlzdDpyZXF9KS50aGVuKHJlcz0+e1xuICAgICAgICAgICAgcmVzLm1hcChpdGVtPT57XG4gICAgICAgICAgICAgICAgaXRlbS5jaG9vc2VVbml0SW5kZXggPSAwXG4gICAgICAgICAgICAgICAgaXRlbS5hbW91bnQgPSAxXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGxldCB1bml0QXJyID0gWy4uLnJlc107XG4gICAgICAgICAgICAodGhpcyBhcyBhbnkpLnNldERhdGEoeyB1bml0QXJyOnVuaXRBcnIgfSwoKT0+e1xuICAgICAgICAgICAgICAgIHRoaXMudG90YWxFbmVyZ3koKVxuICAgICAgICAgICAgfSlcbiAgICAgICAgfSkuY2F0Y2goZXJyPT57XG4gICAgICAgICAgICB3eC5zaG93VG9hc3Qoe3RpdGxlOmVyci5tc2csaWNvbjonbm9uZSd9KVxuICAgICAgICB9KVxuICAgIH1cbiAgICAvKipcbiAgICAgKiDnlKjmiLfovpPlhaXliIbph49cbiAgICAgKi9cbiAgICBwdWJsaWMgaGFuZGxlQW1vdW50SW5wdXQoZTphbnkpe1xuICAgICAgICBjb25zdCBpbnB1dEluZGV4ID0gZS5jdXJyZW50VGFyZ2V0LmRhdGFzZXQuaW5wdXRJbmRleDtcbiAgICAgICAgbGV0IHsgdmFsdWUgfSA9IGUuZGV0YWlsO1xuICAgICAgICB2YWx1ZSA9IHBhcnNlSW50KHZhbHVlKTtcbiAgICAgICAgdGhpcy5kYXRhLnVuaXRBcnJbaW5wdXRJbmRleF0uYW1vdW50ID0gdmFsdWU7XG4gICAgICAgICh0aGlzIGFzIGFueSkuc2V0RGF0YSh7dW5pdEFycjp0aGlzLmRhdGEudW5pdEFycn0sKCk9PntcbiAgICAgICAgICAgIHRoaXMudG90YWxFbmVyZ3koKVxuICAgICAgICB9KVxuICAgIH1cbiAgICBwdWJsaWMgaGFuZGxlQW1vdW50SW5wdXRGb2N1cyhlOmFueSl7XG4gICAgICAgIGNvbnN0IGlucHV0SW5kZXggPSBlLmN1cnJlbnRUYXJnZXQuZGF0YXNldC5pbnB1dEluZGV4O1xuICAgICAgICBsZXQgaXRlbSA9IHRoaXMuZGF0YS51bml0QXJyW2lucHV0SW5kZXhdO1xuICAgICAgICBpdGVtLmZvY3VzQW1vdW50ID0gaXRlbS5hbW91bnQ7XG4gICAgICAgIGl0ZW0uYW1vdW50ID0gMDtcbiAgICAgICAgKHRoaXMgYXMgYW55KS5zZXREYXRhKHt1bml0QXJyOnRoaXMuZGF0YS51bml0QXJyfSlcbiAgICB9XG4gICAgcHVibGljIGhhbmRsZUFtb3VudElucHV0Qmx1cihlOmFueSl7XG4gICAgICAgIGNvbnN0IGlucHV0SW5kZXggPSBlLmN1cnJlbnRUYXJnZXQuZGF0YXNldC5pbnB1dEluZGV4O1xuICAgICAgICBsZXQgaXRlbSA9IHRoaXMuZGF0YS51bml0QXJyW2lucHV0SW5kZXhdO1xuICAgICAgICBpZihpdGVtLmFtb3VudD09MCl7XG4gICAgICAgICAgICBkZWJ1Z2dlclxuICAgICAgICAgICAgaXRlbS5hbW91bnQgPSBpdGVtLmZvY3VzQW1vdW50O1xuICAgICAgICAgICAgKHRoaXMgYXMgYW55KS5zZXREYXRhKHt1bml0QXJyOnRoaXMuZGF0YS51bml0QXJyfSlcbiAgICAgICAgfVxuICAgIH1cbiAgICAvKipcbiAgICAgKiDorqHnrpfng63ph4/mgLvlgLxcbiAgICAgKi9cbiAgICBwdWJsaWMgdG90YWxFbmVyZ3koKXtcbiAgICAgICAgbGV0IHVuaXRBcnIgPSB0aGlzLmRhdGEudW5pdEFyclxuICAgICAgICBsZXQgdG90YWxFbmVyZ3kgPSB1bml0QXJyLnJlZHVjZSgocHJlLG5leHQpPT57XG4gICAgICAgICAgICByZXR1cm4gbmV4dC5hbW91bnQvMTAwICogbmV4dC51bml0T3B0aW9uW25leHQuY2hvb3NlVW5pdEluZGV4XS5lbmVyZ3krcHJlXG4gICAgICAgIH0sMCk7XG4gICAgICAgIHRvdGFsRW5lcmd5ID0gTWF0aC5yb3VuZCh0b3RhbEVuZXJneSk7XG4gICAgICAgICh0aGlzIGFzIGFueSkuc2V0RGF0YSh7dG90YWxFbmVyZ3k6dG90YWxFbmVyZ3l9KVxuICAgIH1cbiAgICAvKipcbiAgICAgKiDot7PovazliLDliIbph4/kvLDnrpfpobXpnaJcbiAgICAgKi9cbiAgICBwdWJsaWMgaGFuZGxlR29XZWlnaHRSZWZlcmVuY2VQYWdlKCl7XG4gICAgICAgIHd4Lm5hdmlnYXRlVG8oeyB1cmw6ICcuLy4uL3dlaWdodFJlZmVyZW5jZS9pbmRleCcgfSlcbiAgICB9XG4gICAgLyoqXG4gICAgICog5Y+R5Ye6YXBp6K+35rGC77yM56Gu5a6a55Sf5oiQbWVhbExvZ1xuICAgICAqL1xuICAgIHB1YmxpYyBjcmVhdGVNZWFsTG9nKCl7XG4gICAgICAgIGNvbnN0IHttZWFsRGF0ZSxtZWFsVHlwZSxpbWdLZXksaW1nVyxpbWdILHRhZ2dzfSA9IHRoaXMuZGF0YTtcbiAgICAgICAgdGFnZ3MubWFwKChpdGVtLGluZGV4KT0+e1xuICAgICAgICAgICAgY29uc3QgY2hvb3NlVW5pdEl0ZW0gPSB0aGlzLmRhdGEudW5pdEFycltpbmRleF07XG4gICAgICAgICAgICBpdGVtLmlucHV0VHlwZSA9IDE7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyg4OCx0aGlzLmRhdGEudW5pdEFycilcbiAgICAgICAgICAgIGl0ZW0uYW1vdW50ID0gY2hvb3NlVW5pdEl0ZW0uYW1vdW50O1xuICAgICAgICAgICAgaXRlbS51bml0SWQgPSBjaG9vc2VVbml0SXRlbS51bml0T3B0aW9uW2Nob29zZVVuaXRJdGVtLmNob29zZVVuaXRJbmRleF0udW5pdElkO1xuICAgICAgICAgICAgaXRlbS5yZWNvZ25pdGlvblJlc3VsdHMgPSBbLi4uaXRlbS5yZXN1bHRMaXN0XTtcbiAgICAgICAgICAgIGRlbGV0ZSBpdGVtLnJlc3VsdExpc3Q7XG4gICAgICAgICAgICBkZWxldGUgaXRlbS5zZWxlY3RlZFBvcztcbiAgICAgICAgfSk7XG4gICAgICAgIGRlYnVnZ2VyXG4gICAgICAgIGxldCByZXEgPSB7XG4gICAgICAgICAgICBtZWFsRGF0ZSxcbiAgICAgICAgICAgIG1lYWxUeXBlLFxuICAgICAgICAgICAgaW1nS2V5LFxuICAgICAgICAgICAgaW1nVyxcbiAgICAgICAgICAgIGltZ0gsXG4gICAgICAgICAgICBmb29kSW5mb0xpc3Q6dGFnZ3NcbiAgICAgICAgfVxuICAgICAgICB3eC5zaG93TG9hZGluZyh7ICB0aXRsZTogJ+WKoOi9veS4rS4uLicgfSk7XG4gICAgICAgIHJlcXVlc3QuY3JlYXRlTWVhbExvZyhyZXEpLnRoZW4ocmVzPT57XG4gICAgICAgICAgICB3eC5oaWRlTG9hZGluZygpO1xuICAgICAgICAgICAgd3guc2hvd1RvYXN0KHt0aXRsZTon6aOf54mp6K6w5b2V5oiQ5YqfJ30pXG4gICAgICAgICAgICBzZXRUaW1lb3V0KCgpPT57XG4gICAgICAgICAgICAgICAgd3guc3dpdGNoVGFiKHt1cmw6ICcvcGFnZXMvaG9tZS9pbmRleCd9KTtcbiAgICAgICAgICAgIH0sMTQ1MClcbiAgICAgICAgfSkuY2F0Y2goZXJyPT57XG4gICAgICAgICAgICBjb25zb2xlLmxvZygxMjIsZXJyKVxuICAgICAgICB9KVxuICAgIH1cblxufVxuXG5QYWdlKG5ldyBDb25maXJtTWVhbCgpKTsiXX0=