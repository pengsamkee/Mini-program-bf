"use strict";
var __assign = (this && this.__assign) || function () {
    __assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return __assign.apply(this, arguments);
};
Object.defineProperty(exports, "__esModule", { value: true });
var webAPI = require("../../api/app/AppService");
var interface_1 = require("../../api/app/interface");
var globalEnum = require("../../api/GlobalEnum");
var textCache = require("./textCache/TextCache");
var textSearch = (function () {
    function textSearch() {
        this.filterType = 0;
        this.mealType = 0;
        this.naviType = 0;
        this.mealDate = 0;
        this.data = {
            keyword: "",
            inputShowed: false,
            resultList: [],
            resultError: [],
            recentList: [],
            showChoosedLists: false,
            showChoosedConfirm: false,
            showPopup: false,
            showPicker: false,
            choosedLists: [],
            unitArr: ['克', '碗', '把', '捧', '盆', '瓢'],
            foodUnitAndUnitEnergy: [],
            foodNumValue: 100,
            foodNumValueMaxlength: 3,
            chooseUinitIndex: 0,
            textSearchResultSelectIndex: null,
            recentResultSelectIndex: null,
            totalEnergy: 0,
        };
    }
    textSearch.prototype.onLoad = function (options) {
        webAPI.SetAuthToken(wx.getStorageSync(globalEnum.globalKey_token));
        var title = options.title;
        this.filterType = parseInt(options.filterType);
        this.mealType = parseInt(options.mealType);
        this.naviType = parseInt(options.naviType);
        this.mealDate = parseInt(options.mealDate);
        wx.setNavigationBarTitle({
            title: "添加" + title
        });
    };
    textSearch.prototype.onShow = function () {
        if (this.data.resultList.length === 0) {
            this.getRecentList();
            this.getCommonFoodList();
        }
    };
    textSearch.prototype.getCommonFoodList = function () {
        interface_1.default.commonFoodList({}).then(function (res) {
            console.log(res);
        }).catch(function (err) {
            console.log(err);
        });
    };
    textSearch.prototype.getRecentList = function () {
        var recentList = textCache.getAllValue();
        this.setData({
            recentList: recentList
        });
    };
    textSearch.prototype.showInput = function () {
        this.setData({
            inputShowed: true
        });
    };
    textSearch.prototype.clearInput = function () {
        this.setData({
            keyword: "",
            resultError: false
        });
    };
    textSearch.prototype.inputTyping = function (event) {
        this.setData({
            resultError: false,
            keyword: event.detail.value,
        });
    };
    textSearch.prototype.performSearch = function () {
        var keyword = this.data.keyword;
        var req = { query: keyword, filter_type: this.filterType, meal_type: this.mealType };
        var that = this;
        wx.showLoading({
            title: '加载中...'
        });
        webAPI.RetrieveTextSearch(req).then(function (resp) {
            wx.hideLoading();
            that.setResultList(resp);
        }).catch(function (err) { return console.log(err); });
    };
    textSearch.prototype.setResultList = function (resp) {
        var results = [];
        if (resp.result_list.length == 0) {
            this.setData({
                resultList: [],
                resultError: true
            });
        }
        else {
            for (var index in resp.result_list) {
                var item = resp.result_list[index];
                var result = {
                    foodId: item.food_id,
                    foodName: item.food_name,
                    foodType: item.food_type,
                    amount: item.amount,
                    unit: item.unit_name,
                    energy: Math.floor(item.energy / 100)
                };
                results.push(result);
            }
            this.setData({
                resultList: results,
                resultError: false
            });
        }
        console.log(this.data.resultList);
    };
    textSearch.prototype.onTextSearchResultSelect = function (event) {
        var _this = this;
        var index = event.currentTarget.dataset.textIndex;
        var unit_option = [
            { "unit_name": "克", "weight": 800, "unit_id": 70 },
            { "unit_name": "鸡蛋大小", "weight": 36000, "unit_id": 74 },
            { "unit_name": "碗", "weight": 21000, "unit_id": 74 }
        ];
        var arr = unit_option.map(function (item) {
            return ({
                'name': item.unit_name,
                'unitEnergy': item.weight / 100,
                'unit_id': item.unit_id
            });
        });
        var nameArr = arr.map(function (item) { return item.name; });
        this.setData({
            recentResultSelectIndex: null,
            foodNumValue: 100,
            chooseUinitIndex: 0,
            textSearchResultSelectIndex: index,
            unitArr: nameArr,
            foodUnitAndUnitEnergy: arr,
            showPopup: true
        }, function () {
            textCache.setValue(_this.data.resultList[index]);
        });
    };
    textSearch.prototype.onRecentResultSelect = function (event) {
        var index = event.currentTarget.dataset.textIndex;
        var unit_option = [
            { "unit_name": "克", "weight": 800, "unit_id": 70 },
            { "unit_name": "鸡蛋大小", "weight": 36000, "unit_id": 74 },
            { "unit_name": "碗", "weight": 21000, "unit_id": 74 }
        ];
        var arr = unit_option.map(function (item) {
            return ({
                'name': item.unit_name,
                'unitEnergy': item.weight / 100,
                'unit_id': item.unit_id
            });
        });
        var nameArr = arr.map(function (item) { return item.name; });
        this.setData({
            textSearchResultSelectIndex: null,
            foodNumValue: 100,
            chooseUinitIndex: 0,
            recentResultSelectIndex: index,
            unitArr: nameArr,
            foodUnitAndUnitEnergy: arr,
            showPopup: true
        }, function () {
        });
    };
    textSearch.prototype.deleteTextSearchCache = function (event) {
        textCache.clearAll();
        this.getRecentList();
    };
    textSearch.prototype.onClose = function () {
        this.setData({ showPopup: false, showChoosedLists: false });
    };
    textSearch.prototype.toggleChoosedLists = function () {
        this.setData({ showChoosedLists: !this.data.showChoosedLists });
    };
    textSearch.prototype.handleAddFood = function () {
        var _this = this;
        var textSearchResultSelectIndex = this.data.textSearchResultSelectIndex;
        var recentResultSelectIndex = this.data.recentResultSelectIndex;
        var item = recentResultSelectIndex === null ? this.data.resultList[textSearchResultSelectIndex] : this.data.recentList[recentResultSelectIndex];
        item = __assign({}, item, { choosedUnit: this.data.unitArr[this.data.chooseUinitIndex], weightNumber: this.data.foodNumValue, unitEnergy: this.data.foodUnitAndUnitEnergy[this.data.chooseUinitIndex].unitEnergy, unit_id: this.data.foodUnitAndUnitEnergy[this.data.chooseUinitIndex].unit_id });
        this.data.choosedLists.push(item);
        this.setData({
            choosedLists: this.data.choosedLists,
            showPopup: false
        }, function () {
            _this.sumEnergy();
            if (recentResultSelectIndex !== null) {
                textCache.setValue(_this.data.recentList[recentResultSelectIndex]);
                if (_this.data.resultList.length === 0) {
                    _this.getRecentList();
                }
            }
            console.log(_this.data.choosedLists);
        });
    };
    textSearch.prototype.sumEnergy = function () {
        var totalEnergy = this.data.choosedLists.reduce(function (pre, next) {
            return next.weightNumber * next.unitEnergy + pre;
        }, 0);
        this.setData({ totalEnergy: totalEnergy });
    };
    textSearch.prototype.handleFoodNumInput = function (e) {
        this.setData({ foodNumValue: parseInt(e.detail.value) });
    };
    textSearch.prototype.showPicker = function () {
        this.setData({ showPicker: true, showPopup: false });
    };
    textSearch.prototype.onConfirm = function () {
        this.setData({ showPicker: false, showPopup: true });
    };
    textSearch.prototype.onChange = function (e) {
        var chooseUinitIndex = e.detail.index;
        if (this.data.unitArr[chooseUinitIndex] === '克') {
            this.setData({ foodNumValueMaxlength: 3 });
        }
        this.setData({ chooseUinitIndex: chooseUinitIndex });
    };
    textSearch.prototype.handleDeleteChoosedItem = function (e) {
        var _this = this;
        var index = e.currentTarget.dataset.index;
        this.data.choosedLists.splice(index, 1);
        this.setData({ choosedLists: this.data.choosedLists }, function () {
            _this.sumEnergy();
            if (_this.data.choosedLists.length === 0) {
                _this.setData({ showChoosedLists: false });
            }
        });
    };
    textSearch.prototype.handleConfirmBtn = function () {
        wx.showLoading({ title: "加载中...", mask: true });
        var foodList = [];
        this.data.choosedLists.map(function (item) {
            var results = [{ food_id: item.foodId, food_name: item.foodName, food_type: item.foodType }];
            var food = {
                food_id: item.foodId,
                food_type: item.foodType,
                recognition_results: results,
                input_type: 2,
                amount: parseInt(item.weightNumber) * 100,
                unit_id: item.unit_id
            };
            foodList.push(food);
        });
        var req = { meal_id: -1, meal_type: this.mealType, meal_date: this.mealDate, food_list: foodList };
        console.log('请求参数req', req);
        this.CreateOrUpdateMealLog(req);
    };
    textSearch.prototype.CreateOrUpdateMealLog = function (req) {
        var _this = this;
        var imageUrl = "https://dietlens-1258665547.cos.ap-shanghai.myqcloud.com/mini-app-image/defaultImage/textsearch-default-image.png";
        webAPI.CreateOrUpdateMealLog(req).then(function (resp) {
            _this.ConfirmMealLog(resp.meal_id);
        }).catch(function (err) {
            wx.showToast({ title: '请求失败', icon: 'none' });
            wx.hideLoading({});
        });
    };
    textSearch.prototype.ConfirmMealLog = function (meal_id) {
        var _this = this;
        var req = { meal_id: meal_id };
        webAPI.ConfirmMealLog(req).then(function (resp) {
            wx.hideLoading({});
            wx.navigateTo({ url: "../../homeSub/pages/mealAnalysis/index?mealDate=" + _this.mealDate + "&mealType=" + _this.mealType });
        }).catch(function (err) {
            wx.showToast({ title: '提交食物记录失败', icon: 'none' });
        });
    };
    return textSearch;
}());
Page(new textSearch());
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7O0FBQUEsaURBQW1EO0FBQ25ELHFEQUE4QztBQUU5QyxpREFBa0Q7QUFDbEQsaURBQWtEO0FBY2xEO0lBQUE7UUFDUyxlQUFVLEdBQUcsQ0FBQyxDQUFDO1FBQ2YsYUFBUSxHQUFHLENBQUMsQ0FBQztRQUNiLGFBQVEsR0FBRyxDQUFDLENBQUM7UUFDYixhQUFRLEdBQUcsQ0FBQyxDQUFDO1FBRWIsU0FBSSxHQUFHO1lBQ1osT0FBTyxFQUFFLEVBQUU7WUFDWCxXQUFXLEVBQUUsS0FBSztZQUNsQixVQUFVLEVBQUUsRUFBRTtZQUNkLFdBQVcsRUFBRSxFQUFFO1lBQ2YsVUFBVSxFQUFFLEVBQUU7WUFDZCxnQkFBZ0IsRUFBQyxLQUFLO1lBQ3RCLGtCQUFrQixFQUFDLEtBQUs7WUFDeEIsU0FBUyxFQUFFLEtBQUs7WUFDaEIsVUFBVSxFQUFDLEtBQUs7WUFDaEIsWUFBWSxFQUFDLEVBQUU7WUFDZixPQUFPLEVBQUMsQ0FBQyxHQUFHLEVBQUMsR0FBRyxFQUFDLEdBQUcsRUFBQyxHQUFHLEVBQUMsR0FBRyxFQUFDLEdBQUcsQ0FBQztZQUNqQyxxQkFBcUIsRUFBQyxFQUFFO1lBQ3hCLFlBQVksRUFBQyxHQUFHO1lBQ2hCLHFCQUFxQixFQUFDLENBQUM7WUFDdkIsZ0JBQWdCLEVBQUMsQ0FBQztZQUNsQiwyQkFBMkIsRUFBQyxJQUFJO1lBQ2hDLHVCQUF1QixFQUFDLElBQUk7WUFDNUIsV0FBVyxFQUFDLENBQUM7U0FDZCxDQUFBO0lBNFhILENBQUM7SUExWFEsMkJBQU0sR0FBYixVQUFjLE9BQVk7UUFDeEIsTUFBTSxDQUFDLFlBQVksQ0FBQyxFQUFFLENBQUMsY0FBYyxDQUFDLFVBQVUsQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDO1FBQ25FLElBQUksS0FBSyxHQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUM7UUFDMUIs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LE9BQU8sQ0FBQyxDQUFBO1FBQ25DLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxVQUFBLEdBQUc7WUFDVixFQUFFLENBQUMsU0FBUyxDQUFDLEVBQUMsS0FBSyxFQUFFLE1BQU0sRUFBQyxJQUFJLEVBQUUsTUFBTSxFQUFDLENBQUMsQ0FBQztZQUMzQyxFQUFFLENBQUMsV0FBVyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ3JCLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUlNLG1DQUFjLEdBQXJCLFVBQXNCLE9BQWM7UUFBcEMsaUJBUUM7UUFQQyxJQUFJLEdBQUcsR0FBRyxFQUFFLE9BQU8sRUFBRSxPQUFPLEVBQUUsQ0FBQztRQUMvQixNQUFNLENBQUMsY0FBYyxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFBLElBQUk7WUFDbEMsRUFBRSxDQUFDLFdBQVcsQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUNuQixFQUFFLENBQUMsVUFBVSxDQUFDLEVBQUUsR0FBRyxFQUFFLHFEQUFtRCxLQUFJLENBQUMsUUFBUSxrQkFBYSxLQUFJLENBQUMsUUFBVSxFQUFDLENBQUMsQ0FBQTtRQUNySCxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsVUFBQSxHQUFHO1lBQ1YsRUFBRSxDQUFDLFNBQVMsQ0FBQyxFQUFDLEtBQUssRUFBRSxVQUFVLEVBQUMsSUFBSSxFQUFFLE1BQU0sRUFBQyxDQUFDLENBQUM7UUFDakQsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUgsaUJBQUM7QUFBRCxDQUFDLEFBclpELElBcVpDO0FBRUQsSUFBSSxDQUFDLElBQUksVUFBVSxFQUFFLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIHdlYkFQSSBmcm9tICcuLi8uLi9hcGkvYXBwL0FwcFNlcnZpY2UnO1xuaW1wb3J0IHJlcXVlc3QgZnJvbSAnLi4vLi4vYXBpL2FwcC9pbnRlcmZhY2UnO1xuaW1wb3J0IHsgUmV0cmlldmVUZXh0U2VhcmNoUmVxLCBSZXRyaWV2ZVRleHRTZWFyY2hSZXNwLCBDcmVhdGVPclVwZGF0ZU1lYWxMb2dSZXEsIEFkZFJlY2lwZUl0ZW1SZXEsIE1lYWxMb2dSZXNwIH0gZnJvbSBcIi9hcGkvYXBwL0FwcFNlcnZpY2VPYmpzXCJcbmltcG9ydCAqIGFzIGdsb2JhbEVudW0gZnJvbSAnLi4vLi4vYXBpL0dsb2JhbEVudW0nXG5pbXBvcnQgKiBhcyB0ZXh0Q2FjaGUgZnJvbSAnLi90ZXh0Q2FjaGUvVGV4dENhY2hlJ1xuXG50eXBlIGRhdGEgPSB7XG4gIGtleXdvcmQ6IFN0cmluZztcbiAgcmVzdWx0TGlzdDogUmVzdWx0W107XG59XG5cbnR5cGUgUmVzdWx0ID0ge1xuICBmb29kSWQ6IG51bWJlcjtcbiAgZGlzcGxheU5hbWU6IFN0cmluZztcbiAgZm9vZFR5cGU6IG51bWJlcjtcbiAgZW5ncnk6IG51bWJlcjtcbn1cblxuY2xhc3MgdGV4dFNlYXJjaCB7XG4gIHB1YmxpYyBmaWx0ZXJUeXBlID0gMDsgLy8wLmFsbCAxLnJlY2lwZSAyLmluZ3JlaWRlbnRcbiAgcHVibGljIG1lYWxUeXBlID0gMDsgLy8xLmJyZWFrZmFzdCAyLmx1bmNoIDMuZGlubmVyIDQuc25hY2tcbiAgcHVibGljIG5hdmlUeXBlID0gMDsgLy8wLnRleHRzZWFyY2ggPT4gZGV0YWlsIDEudGV4dHNlYXJjaCA9PiB0YWcgMi50ZXh0c2VhcmNoPT4gaW5ncmVkaWVudFxuICBwdWJsaWMgbWVhbERhdGUgPSAwOyAvL3ByZXYgcGFnZSBtdXN0IHBhc3MgbWVhbERhdGUgdG8gdGV4dFNlYXJjaCBwYWdlXG5cbiAgcHVibGljIGRhdGEgPSB7XG4gICAga2V5d29yZDogXCJcIixcbiAgICBpbnB1dFNob3dlZDogZmFsc2UsXG4gICAgcmVzdWx0TGlzdDogW10sXG4gICAgcmVzdWx0RXJyb3I6IFtdLFxuICAgIHJlY2VudExpc3Q6IFtdLFxuICAgIHNob3dDaG9vc2VkTGlzdHM6ZmFsc2UsXG4gICAgc2hvd0Nob29zZWRDb25maXJtOmZhbHNlLFxuICAgIHNob3dQb3B1cDogZmFsc2UsXG4gICAgc2hvd1BpY2tlcjpmYWxzZSxcbiAgICBjaG9vc2VkTGlzdHM6W10sICAvLyDlt7Lnu4/mt7vliqDnmoTpo5/niankv6Hmga/liJfooahcbiAgICB1bml0QXJyOlsn5YWLJywn56KXJywn5oqKJywn5o2nJywn55uGJywn55OiJ10sXG4gICAgZm9vZFVuaXRBbmRVbml0RW5lcmd5OltdLFxuICAgIGZvb2ROdW1WYWx1ZToxMDAsXG4gICAgZm9vZE51bVZhbHVlTWF4bGVuZ3RoOjMsXG4gICAgY2hvb3NlVWluaXRJbmRleDowLCAvLyDnlKjmiLfpgInmi6nkuoZwaWNrZXLkuK3nmoRpbmRleFxuICAgIHRleHRTZWFyY2hSZXN1bHRTZWxlY3RJbmRleDpudWxsLCAvLyDnlKjmiLfngrnlh7vmloflrZfmkJzntKLliJfooajkuK3nmoTlk6rkuIDpoblcbiAgICByZWNlbnRSZXN1bHRTZWxlY3RJbmRleDpudWxsLCAvLyDnlKjmiLfngrnlh7vkuobljoblj7LnvJPlrZjmlbDnu4TkuK3nmoRpbmRleFxuICAgIHRvdGFsRW5lcmd5OjAsXG4gIH1cblxuICBwdWJsaWMgb25Mb2FkKG9wdGlvbnM6IGFueSkge1xuICAgIHdlYkFQSS5TZXRBdXRoVG9rZW4od3guZ2V0U3RvcmFnZVN5bmMoZ2xvYmFsRW51bS5nbG9iYWxLZXlfdG9rZW4pKTtcbiAgICBsZXQgdGl0bGUgPSBvcHRpb25zLnRpdGxlO1xuICAgIHRoaXMuZmlsdGVyVHlwZSA9IHBhcnNlSW50KG9wdGlvbnMuZmlsdGVyVHlwZSk7XG4gICAgdGhpcy5tZWFsVHlwZSA9IHBhcnNlSW50KG9wdGlvbnMubWVhbFR5cGUpO1xuICAgIHRoaXMubmF2aVR5cGUgPSBwYXJzZUludChvcHRpb25zLm5hdmlUeXBlKTtcbiAgICB0aGlzLm1lYWxEYXRlID0gcGFyc2VJbnQob3B0aW9ucy5tZWFsRGF0ZSk7XG4gICAgd3guc2V0TmF2aWdhdGlvbkJhclRpdGxlKHtcbiAgICAgIHRpdGxlOiBcIua3u+WKoFwiICsgdGl0bGUvL+mhtemdouagh+mimOS4uui3r+eUseWPguaVsFxuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIG9uU2hvdygpIHtcbiAgICBpZiAodGhpcy5kYXRhLnJlc3VsdExpc3QubGVuZ3RoID09PSAwKXtcbiAgICAgIHRoaXMuZ2V0UmVjZW50TGlzdCgpO1xuICAgICAgdGhpcy5nZXRDb21tb25Gb29kTGlzdCgpO1xuICAgIH1cbiAgfVxuICAvKipcbiAgICog6I635Y+W5bi46KeB55qE6aOf54mp5YiX6KGoXG4gICAqL1xuICBwdWJsaWMgZ2V0Q29tbW9uRm9vZExpc3QoKXtcbiAgICByZXF1ZXN0LmNvbW1vbkZvb2RMaXN0KHtcblxuICAgIH0pLnRoZW4ocmVzPT57XG4gICAgICBjb25zb2xlLmxvZyhyZXMpXG4gICAgfSkuY2F0Y2goZXJyPT57XG4gICAgICBjb25zb2xlLmxvZyhlcnIpXG4gICAgfSlcbiAgfVxuXG4gIHB1YmxpYyBnZXRSZWNlbnRMaXN0KCl7XG4gICAgbGV0IHJlY2VudExpc3QgPSB0ZXh0Q2FjaGUuZ2V0QWxsVmFsdWUoKTtcbiAgICAodGhpcyBhcyBhbnkpLnNldERhdGEoe1xuICAgICAgcmVjZW50TGlzdDogcmVjZW50TGlzdFxuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIHNob3dJbnB1dCgpIHtcbiAgICAodGhpcyBhcyBhbnkpLnNldERhdGEoe1xuICAgICAgaW5wdXRTaG93ZWQ6IHRydWVcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBjbGVhcklucHV0KCkge1xuICAgICh0aGlzIGFzIGFueSkuc2V0RGF0YSh7XG4gICAgICBrZXl3b3JkOiBcIlwiLFxuICAgICAgcmVzdWx0RXJyb3I6IGZhbHNlXG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgaW5wdXRUeXBpbmcoZXZlbnQ6IGFueSkge1xuICAgICh0aGlzIGFzIGFueSkuc2V0RGF0YSh7XG4gICAgICByZXN1bHRFcnJvcjogZmFsc2UsXG4gICAgICBrZXl3b3JkOiBldmVudC5kZXRhaWwudmFsdWUsXG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgcGVyZm9ybVNlYXJjaCgpIHtcbiAgICBsZXQga2V5d29yZCA9IHRoaXMuZGF0YS5rZXl3b3JkO1xuICAgIGxldCByZXEgPSB7IHF1ZXJ5OiBrZXl3b3JkLCBmaWx0ZXJfdHlwZTogdGhpcy5maWx0ZXJUeXBlLCBtZWFsX3R5cGU6IHRoaXMubWVhbFR5cGUgfTtcbiAgICB2YXIgdGhhdCA9IHRoaXM7XG4gICAgd3guc2hvd0xvYWRpbmcoe1xuICAgICAgdGl0bGU6J+WKoOi9veS4rS4uLidcbiAgICB9KVxuICAgIHdlYkFQSS5SZXRyaWV2ZVRleHRTZWFyY2gocmVxKS50aGVuKHJlc3AgPT4ge1xuICAgICAgd3guaGlkZUxvYWRpbmcoKVxuICAgICAgdGhhdC5zZXRSZXN1bHRMaXN0KHJlc3ApO1xuICAgIH0pLmNhdGNoKGVyciA9PiBjb25zb2xlLmxvZyhlcnIpKTtcbiAgfVxuXG4gIHB1YmxpYyBzZXRSZXN1bHRMaXN0KHJlc3A6IFJldHJpZXZlVGV4dFNlYXJjaFJlc3ApIHtcbiAgICBsZXQgcmVzdWx0cyA9IFtdO1xuXG4gICAgaWYgKHJlc3AucmVzdWx0X2xpc3QubGVuZ3RoPT0wKSB7XG4gICAgICAodGhpcyBhcyBhbnkpLnNldERhdGEoe1xuICAgICAgICByZXN1bHRMaXN0OiBbXSxcbiAgICAgICAgcmVzdWx0RXJyb3I6IHRydWVcbiAgICAgIH0pXG4gICAgfSBlbHNlIHtcbiAgICAgIGZvciAobGV0IGluZGV4IGluIHJlc3AucmVzdWx0X2xpc3QpIHtcbiAgICAgICAgbGV0IGl0ZW0gPSByZXNwLnJlc3VsdF9saXN0W2luZGV4XTtcbiAgICAgICAgbGV0IHJlc3VsdCA9IHtcbiAgICAgICAgICBmb29kSWQ6IGl0ZW0uZm9vZF9pZCxcbiAgICAgICAgICBmb29kTmFtZTogaXRlbS5mb29kX25hbWUsXG4gICAgICAgICAgZm9vZFR5cGU6IGl0ZW0uZm9vZF90eXBlLFxuICAgICAgICAgIGFtb3VudDogaXRlbS5hbW91bnQsXG4gICAgICAgICAgdW5pdDogaXRlbS51bml0X25hbWUsXG4gICAgICAgICAgZW5lcmd5OiBNYXRoLmZsb29yKGl0ZW0uZW5lcmd5IC8gMTAwKVxuICAgICAgICB9XG4gICAgICAgIHJlc3VsdHMucHVzaChyZXN1bHQpO1xuICAgICAgfVxuICAgICAgKHRoaXMgYXMgYW55KS5zZXREYXRhKHtcbiAgICAgICAgcmVzdWx0TGlzdDogcmVzdWx0cyxcbiAgICAgICAgcmVzdWx0RXJyb3I6IGZhbHNlXG4gICAgICB9KTtcbiAgICB9XG5cblxuICAgIGNvbnNvbGUubG9nKHRoaXMuZGF0YS5yZXN1bHRMaXN0KTtcbiAgfVxuXG4gIC8qKlxuICAgKiB0aHJlZSBjYXNlXG4gICAqIDEuZm9vZERpYXJ5IC0+IHRleHRzZWFyY2ggLT4gZm9vZERldGFpbFBhZ2UocmV0dXJuIGluZ3JlZGllbnQvcmVjZWlwZSlcbiAgICogMi5pbWFnZVRhZyAtPiB0ZXh0c2VhcmNoIC0+IGltYWdlVGFnKHJldHVybiBpbmdyZWRpZW50L3JlY2VpcGUpXG4gICAqIDMuZm9vZERldGFpbCAtPiB0ZXh0c2VhcmNoIC0+IGZvb2REZXRhaWwocmV0dXJuIGluZ3JlZGllbnQpXG4gICAqIGNvbW1vbiBzb2x1dGlvbjogc2V0IHByZXZQYWdlLmRhdGEudGV4dFNlYXJjaEl0ZW1cbiAgICovXG4gIHB1YmxpYyBvblRleHRTZWFyY2hSZXN1bHRTZWxlY3QoZXZlbnQ6IGFueSkge1xuICAgIGxldCBpbmRleCA9IGV2ZW50LmN1cnJlbnRUYXJnZXQuZGF0YXNldC50ZXh0SW5kZXg7XG4gICAgLy8gbGV0IGZvb2RJZCA9IHRoaXMuZGF0YS5yZXN1bHRMaXN0W2luZGV4XS5mb29kSWQ7XG4gICAgLy8gbGV0IGZvb2ROYW1lID0gdGhpcy5kYXRhLnJlc3VsdExpc3RbaW5kZXhdLmZvb2ROYW1lO1xuICAgIC8vIGxldCBmb29kVHlwZSA9IHRoaXMuZGF0YS5yZXN1bHRMaXN0W2luZGV4XS5mb29kVHlwZTtcbiAgICAvLyBsZXQgaW1hZ2VVcmwgPSBcImh0dHBzOi8vZGlldGxlbnMtMTI1ODY2NTU0Ny5jb3MuYXAtc2hhbmdoYWkubXlxY2xvdWQuY29tL21pbmktYXBwLWltYWdlL2RlZmF1bHRJbWFnZS90ZXh0c2VhcmNoLWRlZmF1bHQtaW1hZ2UucG5nXCI7XG4gICAgY29uc3QgdW5pdF9vcHRpb249W1xuICAgICAge1widW5pdF9uYW1lXCI6XCLlhYtcIixcIndlaWdodFwiOjgwMCxcInVuaXRfaWRcIjo3MH0sXG4gICAgICB7XCJ1bml0X25hbWVcIjpcIum4oeibi+Wkp+Wwj1wiLFwid2VpZ2h0XCI6MzYwMDAsXCJ1bml0X2lkXCI6NzR9LFxuICAgICAge1widW5pdF9uYW1lXCI6XCLnopdcIixcIndlaWdodFwiOjIxMDAwLFwidW5pdF9pZFwiOjc0fVxuICAgIF07XG4gICAgY29uc3QgYXJyID0gdW5pdF9vcHRpb24ubWFwKGl0ZW09PntcbiAgICAgIHJldHVybiAoeyBcbiAgICAgICAgJ25hbWUnIDogaXRlbS51bml0X25hbWUsXG4gICAgICAgICd1bml0RW5lcmd5JyA6IGl0ZW0ud2VpZ2h0LzEwMCxcbiAgICAgICAgJ3VuaXRfaWQnIDogaXRlbS51bml0X2lkXG4gICAgICB9KVxuICAgIH0pXG5cbiAgICBjb25zdCBuYW1lQXJyID0gYXJyLm1hcChpdGVtPT5pdGVtLm5hbWUpO1xuICAgICh0aGlzIGFzIGFueSkuc2V0RGF0YSh7XG4gICAgICByZWNlbnRSZXN1bHRTZWxlY3RJbmRleDpudWxsLFxuICAgICAgZm9vZE51bVZhbHVlOjEwMCwgLy8g5Yid5aeL5YyW5pWw6YePMTAw5YWLXG4gICAgICBjaG9vc2VVaW5pdEluZGV4OjAsIC8vIOWIneWni+WMluaVsOmHjzEwMOWFi1xuICAgICAgdGV4dFNlYXJjaFJlc3VsdFNlbGVjdEluZGV4OmluZGV4LFxuICAgICAgdW5pdEFycjpuYW1lQXJyLFxuICAgICAgZm9vZFVuaXRBbmRVbml0RW5lcmd5OmFycixcbiAgICAgIHNob3dQb3B1cDp0cnVlXG4gICAgfSwoKT0+e1xuICAgICAgdGV4dENhY2hlLnNldFZhbHVlKHRoaXMuZGF0YS5yZXN1bHRMaXN0W2luZGV4XSk7XG4gICAgfSlcbiAgICBcbiAgICAvLyBpZiAodGhpcy5uYXZpVHlwZSA9PT0gMCkge1xuICAgIC8vICAgd3guc2hvd0xvYWRpbmcoeyB0aXRsZTogXCLliqDovb3kuK0uLi5cIiwgbWFzazogdHJ1ZSB9KTtcbiAgICAvLyAgIGxldCByZXN1bHRzID0gW3sgZm9vZF9pZDogZm9vZElkLCBmb29kX25hbWU6IGZvb2ROYW1lLCBmb29kX3R5cGU6IGZvb2RUeXBlIH1dO1xuICAgIC8vICAgbGV0IGZvb2QgPSB7IGZvb2RfaWQ6IGZvb2RJZCwgaW5wdXRfdHlwZTogMiwgZm9vZF90eXBlOiBmb29kVHlwZSwgcmVjb2duaXRpb25fcmVzdWx0czogcmVzdWx0cyB9O1xuICAgIC8vICAgbGV0IGZvb2RMaXN0ID0gW2Zvb2RdO1xuICAgIC8vICAgbGV0IHJlcSA9IHsgbWVhbF9pZDogLTEsIG1lYWxfdHlwZTogdGhpcy5tZWFsVHlwZSwgbWVhbF9kYXRlOiB0aGlzLm1lYWxEYXRlLCBmb29kX2xpc3Q6IGZvb2RMaXN0IH07XG4gICAgLy8gICB3ZWJBUEkuQ3JlYXRlT3JVcGRhdGVNZWFsTG9nKHJlcSkudGhlbihyZXNwID0+IHtcbiAgICAvLyAgICAgd3guaGlkZUxvYWRpbmcoe30pO1xuICAgIC8vICAgICBsZXQgcGFyYW0gPSB7fTtcbiAgICAvLyAgICAgcGFyYW0ubWVhbElkID0gcmVzcC5tZWFsX2lkO1xuICAgIC8vICAgICBwYXJhbS5pbWFnZVVybCA9IGltYWdlVXJsO1xuICAgIC8vICAgICBwYXJhbS5zaG93U2hhcmVCdG4gPSBmYWxzZTtcbiAgICAvLyAgICAgbGV0IHBhcmFtSnNvbiA9IEpTT04uc3RyaW5naWZ5KHBhcmFtKTtcbiAgICAvLyAgICAgd3gubmF2aWdhdGVUbyh7XG4gICAgLy8gICAgICAgdXJsOiBcIi9wYWdlcy9mb29kRGV0YWlsL2luZGV4P3BhcmFtSnNvbj1cIiArIHBhcmFtSnNvblxuICAgIC8vICAgICB9KTtcbiAgICAvLyAgIH0pLmNhdGNoKGVyciA9PiB7XG4gICAgLy8gICAgIHd4LmhpZGVMb2FkaW5nKHt9KTtcbiAgICAvLyAgICAgfSk7XG4gICAgLy8gfSBlbHNlIHtcbiAgICAvLyAgIGxldCBwYWdlcyA9IGdldEN1cnJlbnRQYWdlcygpO1xuICAgIC8vICAgbGV0IHByZXZQYWdlID0gcGFnZXNbcGFnZXMubGVuZ3RoIC0gMl07XG4gICAgLy8gICBwcmV2UGFnZS50ZXh0U2VhcmNoRm9vZCA9IHsgZm9vZF9pZDogZm9vZElkLCBmb29kX25hbWU6IGZvb2ROYW1lLCBmb29kX3R5cGU6IGZvb2RUeXBlIH1cbiAgICAvLyAgIHd4Lm5hdmlnYXRlQmFjayh7XG4gICAgLy8gICAgIGRlbHRhOiAxXG4gICAgLy8gICB9KVxuICAgIC8vIH1cblxuICAgIC8vIHRleHRDYWNoZS5zZXRWYWx1ZSh0aGlzLmRhdGEucmVzdWx0TGlzdFtpbmRleF0pO1xuICB9XG5cbiAgcHVibGljIG9uUmVjZW50UmVzdWx0U2VsZWN0KGV2ZW50OiBhbnkpe1xuICAgIGxldCBpbmRleCA9IGV2ZW50LmN1cnJlbnRUYXJnZXQuZGF0YXNldC50ZXh0SW5kZXg7XG4gICAgLy8gbGV0IGZvb2RJZCA9IHRoaXMuZGF0YS5yZWNlbnRMaXN0W2luZGV4XS5mb29kSWQ7XG4gICAgLy8gbGV0IGZvb2ROYW1lID0gdGhpcy5kYXRhLnJlY2VudExpc3RbaW5kZXhdLmZvb2ROYW1lO1xuICAgIC8vIGxldCBmb29kVHlwZSA9IHRoaXMuZGF0YS5yZWNlbnRMaXN0W2luZGV4XS5mb29kVHlwZTtcbiAgICAvLyBsZXQgaW1hZ2VVcmwgPSBcImh0dHBzOi8vZGlldGxlbnMtMTI1ODY2NTU0Ny5jb3MuYXAtc2hhbmdoYWkubXlxY2xvdWQuY29tL21pbmktYXBwLWltYWdlL2RlZmF1bHRJbWFnZS90ZXh0c2VhcmNoLWRlZmF1bHQtaW1hZ2UucG5nXCI7XG4gICAgY29uc3QgdW5pdF9vcHRpb249W1xuICAgICAge1widW5pdF9uYW1lXCI6XCLlhYtcIixcIndlaWdodFwiOjgwMCxcInVuaXRfaWRcIjo3MH0sXG4gICAgICB7XCJ1bml0X25hbWVcIjpcIum4oeibi+Wkp+Wwj1wiLFwid2VpZ2h0XCI6MzYwMDAsXCJ1bml0X2lkXCI6NzR9LFxuICAgICAge1widW5pdF9uYW1lXCI6XCLnopdcIixcIndlaWdodFwiOjIxMDAwLFwidW5pdF9pZFwiOjc0fVxuICAgIF07XG4gICAgY29uc3QgYXJyID0gdW5pdF9vcHRpb24ubWFwKGl0ZW09PntcbiAgICAgIHJldHVybiAoeyBcbiAgICAgICAgJ25hbWUnIDogaXRlbS51bml0X25hbWUsXG4gICAgICAgICd1bml0RW5lcmd5JyA6IGl0ZW0ud2VpZ2h0LzEwMCxcbiAgICAgICAgJ3VuaXRfaWQnIDogaXRlbS51bml0X2lkXG4gICAgICB9KVxuICAgIH0pXG5cbiAgICBjb25zdCBuYW1lQXJyID0gYXJyLm1hcChpdGVtPT5pdGVtLm5hbWUpO1xuICAgICh0aGlzIGFzIGFueSkuc2V0RGF0YSh7XG4gICAgICB0ZXh0U2VhcmNoUmVzdWx0U2VsZWN0SW5kZXg6bnVsbCxcbiAgICAgIGZvb2ROdW1WYWx1ZToxMDAsIC8vIOWIneWni+WMluaVsOmHjzEwMOWFi1xuICAgICAgY2hvb3NlVWluaXRJbmRleDowLCAvLyDliJ3lp4vljJbmlbDph48xMDDlhYtcbiAgICAgIHJlY2VudFJlc3VsdFNlbGVjdEluZGV4OmluZGV4LFxuICAgICAgdW5pdEFycjpuYW1lQXJyLFxuICAgICAgZm9vZFVuaXRBbmRVbml0RW5lcmd5OmFycixcbiAgICAgIHNob3dQb3B1cDp0cnVlXG4gICAgfSwoKT0+e1xuICAgICAgXG4gICAgfSlcbiAgICAvLyB0ZXh0Q2FjaGUuc2V0VmFsdWUodGhpcy5kYXRhLnJlY2VudExpc3RbaW5kZXhdKTtcblxuICAgIC8vIGlmICh0aGlzLm5hdmlUeXBlID09PSAwKSB7XG4gICAgLy8gICB3eC5zaG93TG9hZGluZyh7IHRpdGxlOiBcIuWKoOi9veS4rS4uLlwiLCBtYXNrOiB0cnVlIH0pO1xuICAgIC8vICAgbGV0IHJlc3VsdHMgPSBbeyBmb29kX2lkOiBmb29kSWQsIGZvb2RfbmFtZTogZm9vZE5hbWUsIGZvb2RfdHlwZTogZm9vZFR5cGUgfV07XG4gICAgLy8gICBsZXQgZm9vZCA9IHsgZm9vZF9pZDogZm9vZElkLCBpbnB1dF90eXBlOiAyLCBmb29kX3R5cGU6IGZvb2RUeXBlLCByZWNvZ25pdGlvbl9yZXN1bHRzOiByZXN1bHRzIH07XG4gICAgLy8gICBsZXQgZm9vZExpc3QgPSBbZm9vZF07XG4gICAgLy8gICBsZXQgcmVxID0geyBtZWFsX2lkOiAtMSwgbWVhbF90eXBlOiB0aGlzLm1lYWxUeXBlLCBtZWFsX2RhdGU6IHRoaXMubWVhbERhdGUsIGZvb2RfbGlzdDogZm9vZExpc3QgfTtcbiAgICAvLyAgIHdlYkFQSS5DcmVhdGVPclVwZGF0ZU1lYWxMb2cocmVxKS50aGVuKHJlc3AgPT4ge1xuICAgIC8vICAgICB3eC5oaWRlTG9hZGluZyh7fSk7XG4gICAgLy8gICAgIGxldCBwYXJhbSA9IHt9O1xuICAgIC8vICAgICBwYXJhbS5tZWFsSWQgPSByZXNwLm1lYWxfaWQ7XG4gICAgLy8gICAgIHBhcmFtLmltYWdlVXJsID0gaW1hZ2VVcmw7XG4gICAgLy8gICAgIHBhcmFtLnNob3dTaGFyZUJ0biA9IGZhbHNlO1xuICAgIC8vICAgICBsZXQgcGFyYW1Kc29uID0gSlNPTi5zdHJpbmdpZnkocGFyYW0pO1xuICAgIC8vICAgICB3eC5uYXZpZ2F0ZVRvKHtcbiAgICAvLyAgICAgICB1cmw6IFwiL3BhZ2VzL2Zvb2REZXRhaWwvaW5kZXg/cGFyYW1Kc29uPVwiICsgcGFyYW1Kc29uXG4gICAgLy8gICAgIH0pO1xuICAgIC8vICAgfSkuY2F0Y2goZXJyID0+IHtcbiAgICAvLyAgICAgY29uc29sZS5sb2coZXJyKTtcbiAgICAvLyAgICAgd3guaGlkZUxvYWRpbmcoe30pO1xuICAgIC8vICAgfSk7XG4gICAgLy8gfSBlbHNlIHtcbiAgICAvLyAgIGxldCBwYWdlcyA9IGdldEN1cnJlbnRQYWdlcygpO1xuICAgIC8vICAgbGV0IHByZXZQYWdlID0gcGFnZXNbcGFnZXMubGVuZ3RoIC0gMl07XG4gICAgLy8gICBwcmV2UGFnZS50ZXh0U2VhcmNoRm9vZCA9IHsgZm9vZF9pZDogZm9vZElkLCBmb29kX25hbWU6IGZvb2ROYW1lLCBmb29kX3R5cGU6IGZvb2RUeXBlIH1cbiAgICAvLyAgIHd4Lm5hdmlnYXRlQmFjayh7XG4gICAgLy8gICAgIGRlbHRhOiAxXG4gICAgLy8gICB9KVxuICAgIC8vIH1cbiAgIFxuICB9XG5cbiAgcHVibGljIGRlbGV0ZVRleHRTZWFyY2hDYWNoZShldmVudDogYW55KXtcbiAgICB0ZXh0Q2FjaGUuY2xlYXJBbGwoKTtcbiAgICB0aGlzLmdldFJlY2VudExpc3QoKTtcbiAgfVxuICAvKipcbiAgICog5YWz6Zet5by556qXcG9wdXDmoYZcbiAgICovXG4gIHB1YmxpYyBvbkNsb3NlKCl7XG4gICAgKHRoaXMgYXMgYW55KS5zZXREYXRhKHsgc2hvd1BvcHVwOiBmYWxzZSxzaG93Q2hvb3NlZExpc3RzOmZhbHNlfSk7XG4gIH1cbi8qKlxuICog5YiH5o2i5bey6YCJ6aOf54mp5YiX6KGo55qE5pi+56S65LiO6ZqQ6JePXG4gKi9cbiAgcHVibGljIHRvZ2dsZUNob29zZWRMaXN0cygpe1xuICAgICh0aGlzIGFzIGFueSkuc2V0RGF0YSh7c2hvd0Nob29zZWRMaXN0czohdGhpcy5kYXRhLnNob3dDaG9vc2VkTGlzdHN9KVxuICB9XG4gIC8qKlxuICAgKiDngrnlh7vmt7vliqDmjInpkq7vvIzlsIbpo5/nianmt7vliqDoh7Plt7LpgIlcbiAgICovXG4gIHB1YmxpYyBoYW5kbGVBZGRGb29kKCl7XG4gICAgbGV0IHRleHRTZWFyY2hSZXN1bHRTZWxlY3RJbmRleCA9IHRoaXMuZGF0YS50ZXh0U2VhcmNoUmVzdWx0U2VsZWN0SW5kZXg7XG4gICAgbGV0IHJlY2VudFJlc3VsdFNlbGVjdEluZGV4ID0gdGhpcy5kYXRhLnJlY2VudFJlc3VsdFNlbGVjdEluZGV4O1xuICAgIGxldCBpdGVtOmFueSA9IHJlY2VudFJlc3VsdFNlbGVjdEluZGV4ID09PSBudWxsID8gdGhpcy5kYXRhLnJlc3VsdExpc3RbdGV4dFNlYXJjaFJlc3VsdFNlbGVjdEluZGV4XSA6IHRoaXMuZGF0YS5yZWNlbnRMaXN0W3JlY2VudFJlc3VsdFNlbGVjdEluZGV4XTtcbiAgICBpdGVtID0ge1xuICAgICAgLi4uaXRlbSxcbiAgICAgIGNob29zZWRVbml0OnRoaXMuZGF0YS51bml0QXJyW3RoaXMuZGF0YS5jaG9vc2VVaW5pdEluZGV4XSxcbiAgICAgIHdlaWdodE51bWJlcjp0aGlzLmRhdGEuZm9vZE51bVZhbHVlLFxuICAgICAgdW5pdEVuZXJneTp0aGlzLmRhdGEuZm9vZFVuaXRBbmRVbml0RW5lcmd5W3RoaXMuZGF0YS5jaG9vc2VVaW5pdEluZGV4XS51bml0RW5lcmd5LFxuICAgICAgdW5pdF9pZDp0aGlzLmRhdGEuZm9vZFVuaXRBbmRVbml0RW5lcmd5W3RoaXMuZGF0YS5jaG9vc2VVaW5pdEluZGV4XS51bml0X2lkXG4gICAgfTtcbiAgICB0aGlzLmRhdGEuY2hvb3NlZExpc3RzLnB1c2goaXRlbSk7XG4gICAgKHRoaXMgYXMgYW55KS5zZXREYXRhKHsgXG4gICAgICBjaG9vc2VkTGlzdHMgOiB0aGlzLmRhdGEuY2hvb3NlZExpc3RzLFxuICAgICAgc2hvd1BvcHVwIDogZmFsc2VcbiAgICB9LCgpPT57XG4gICAgICB0aGlzLnN1bUVuZXJneSgpO1xuICAgICAgaWYocmVjZW50UmVzdWx0U2VsZWN0SW5kZXggIT09IG51bGwpe1xuICAgICAgICB0ZXh0Q2FjaGUuc2V0VmFsdWUodGhpcy5kYXRhLnJlY2VudExpc3RbcmVjZW50UmVzdWx0U2VsZWN0SW5kZXhdKVxuICAgICAgICBpZiAodGhpcy5kYXRhLnJlc3VsdExpc3QubGVuZ3RoID09PSAwKXtcbiAgICAgICAgICB0aGlzLmdldFJlY2VudExpc3QoKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgY29uc29sZS5sb2codGhpcy5kYXRhLmNob29zZWRMaXN0cykgICBcbiAgICB9KVxuICB9XG4gIC8qKlxuICAgKiBAcGFyYW0g6K6h566X55So5oi36aOf54mp5LiA5YWx5pyJ5aSa5bCR54Ot6YePXG4gICAqL1xuICBwdWJsaWMgc3VtRW5lcmd5KCl7XG4gICAgY29uc3QgdG90YWxFbmVyZ3kgPSB0aGlzLmRhdGEuY2hvb3NlZExpc3RzLnJlZHVjZSgocHJlLG5leHQpPT57XG4gICAgICByZXR1cm4gbmV4dC53ZWlnaHROdW1iZXIqbmV4dC51bml0RW5lcmd5K3ByZVxuICAgIH0sMCk7XG4gICAgKHRoaXMgYXMgYW55KS5zZXREYXRhKHt0b3RhbEVuZXJneTp0b3RhbEVuZXJneX0pXG4gIH1cblxuICAvKipcbiAgICog55So5oi36L6T5YWl6aOf54mp55qE5Lu95pWwXG4gICAqL1xuICBwdWJsaWMgaGFuZGxlRm9vZE51bUlucHV0KGU6YW55KXtcbiAgICAodGhpcyBhcyBhbnkpLnNldERhdGEoe2Zvb2ROdW1WYWx1ZTpwYXJzZUludChlLmRldGFpbC52YWx1ZSl9KVxuICB9XG4gIC8qKlxuICAgKiDlsZXnpLpwaWNrZXLvvIzpgInmi6npo5/nianljZXkvY1cbiAgICovXG4gIHB1YmxpYyBzaG93UGlja2VyKCl7XG4gICAgKHRoaXMgYXMgYW55KS5zZXREYXRhKHtzaG93UGlja2VyOnRydWUsc2hvd1BvcHVwOmZhbHNlfSlcbiAgfVxuICBwdWJsaWMgb25Db25maXJtKCl7XG4gICAgKHRoaXMgYXMgYW55KS5zZXREYXRhKHtzaG93UGlja2VyOmZhbHNlLHNob3dQb3B1cDp0cnVlfSlcbiAgfVxuICBwdWJsaWMgb25DaGFuZ2UoZTphbnkpe1xuICAgIGxldCBjaG9vc2VVaW5pdEluZGV4Om51bWJlciA9IGUuZGV0YWlsLmluZGV4O1xuICAgIGlmKHRoaXMuZGF0YS51bml0QXJyW2Nob29zZVVpbml0SW5kZXhdPT09J+WFiycpe1xuICAgICAgKHRoaXMgYXMgYW55KS5zZXREYXRhKHtmb29kTnVtVmFsdWVNYXhsZW5ndGg6M30pXG4gICAgfVxuICAgICh0aGlzIGFzIGFueSkuc2V0RGF0YSh7Y2hvb3NlVWluaXRJbmRleDpjaG9vc2VVaW5pdEluZGV4fSlcbiAgfVxuICAvKipcbiAgICog5Yig6Zmk6YCJ5Lit5YiX6KGo5Lit55qE5p+Q5LiA6aG5XG4gICAqL1xuICBwdWJsaWMgaGFuZGxlRGVsZXRlQ2hvb3NlZEl0ZW0oZTphbnkpe1xuICAgIGxldCBpbmRleCA9IGUuY3VycmVudFRhcmdldC5kYXRhc2V0LmluZGV4O1xuICAgIHRoaXMuZGF0YS5jaG9vc2VkTGlzdHMuc3BsaWNlKGluZGV4LDEpO1xuICAgICh0aGlzIGFzIGFueSkuc2V0RGF0YSh7Y2hvb3NlZExpc3RzOnRoaXMuZGF0YS5jaG9vc2VkTGlzdHN9LCgpPT57XG4gICAgICB0aGlzLnN1bUVuZXJneSgpXG4gICAgICBpZih0aGlzLmRhdGEuY2hvb3NlZExpc3RzLmxlbmd0aD09PTApe1xuICAgICAgICAodGhpcyBhcyBhbnkpLnNldERhdGEoe3Nob3dDaG9vc2VkTGlzdHM6ZmFsc2V9KVxuICAgICAgfVxuICAgIH0pXG4gIH1cbiAgLyoqXG4gICAqIOaJuemHj+a3u+WKoOmjn+eJqeaVtOWQiOWPguaVsFxuICAgKi9cbiAgcHVibGljIGhhbmRsZUNvbmZpcm1CdG4oKXtcbiAgICB3eC5zaG93TG9hZGluZyh7IHRpdGxlOiBcIuWKoOi9veS4rS4uLlwiLCBtYXNrOiB0cnVlIH0pO1xuICAgIGxldCBmb29kTGlzdDphbnlbXSA9IFtdO1xuICAgIHRoaXMuZGF0YS5jaG9vc2VkTGlzdHMubWFwKChpdGVtOmFueSkgPT4ge1xuICAgICAgbGV0IHJlc3VsdHMgPSBbeyBmb29kX2lkOiBpdGVtLmZvb2RJZCwgZm9vZF9uYW1lOiBpdGVtLmZvb2ROYW1lLCBmb29kX3R5cGU6IGl0ZW0uZm9vZFR5cGUgfV07XG4gICAgICBsZXQgZm9vZCA9IHsgXG4gICAgICAgIGZvb2RfaWQ6IGl0ZW0uZm9vZElkLCBcbiAgICAgICAgZm9vZF90eXBlOiBpdGVtLmZvb2RUeXBlLCBcbiAgICAgICAgcmVjb2duaXRpb25fcmVzdWx0czogcmVzdWx0cyxcbiAgICAgICAgaW5wdXRfdHlwZTogMiwgXG4gICAgICAgIGFtb3VudDpwYXJzZUludChpdGVtLndlaWdodE51bWJlcikqMTAwLFxuICAgICAgICB1bml0X2lkOiBpdGVtLnVuaXRfaWRcbiAgICAgIH07XG4gICAgICBmb29kTGlzdC5wdXNoKGZvb2QpXG4gICAgfSlcbiAgICBsZXQgcmVxID0geyBtZWFsX2lkOiAtMSwgbWVhbF90eXBlOiB0aGlzLm1lYWxUeXBlLCBtZWFsX2RhdGU6IHRoaXMubWVhbERhdGUsIGZvb2RfbGlzdDogZm9vZExpc3QgfTtcbiAgICBjb25zb2xlLmxvZygn6K+35rGC5Y+C5pWwcmVxJyxyZXEpXG4gICAgdGhpcy5DcmVhdGVPclVwZGF0ZU1lYWxMb2cocmVxKTtcbiAgfVxuICAvKipcbiAgICog5qC85byP5YyW5pWw5o2u5ZCO77yM5Y+R5Ye66K+35rGC77yM6I635b6XbWVhbF9pZFxuICAgKi9cbiAgcHVibGljIENyZWF0ZU9yVXBkYXRlTWVhbExvZyhyZXE6YW55KXtcbiAgICBsZXQgaW1hZ2VVcmwgPSBcImh0dHBzOi8vZGlldGxlbnMtMTI1ODY2NTU0Ny5jb3MuYXAtc2hhbmdoYWkubXlxY2xvdWQuY29tL21pbmktYXBwLWltYWdlL2RlZmF1bHRJbWFnZS90ZXh0c2VhcmNoLWRlZmF1bHQtaW1hZ2UucG5nXCI7XG4gICAgd2ViQVBJLkNyZWF0ZU9yVXBkYXRlTWVhbExvZyhyZXEpLnRoZW4ocmVzcCA9PiB7XG4gICAgICAvLyBsZXQgcGFyYW06YW55ID0ge307XG4gICAgICAvLyBwYXJhbS5tZWFsSWQgPSByZXNwLm1lYWxfaWQ7XG4gICAgICAvLyBwYXJhbS5pbWFnZVVybCA9IGltYWdlVXJsO1xuICAgICAgLy8gcGFyYW0uc2hvd1NoYXJlQnRuID0gZmFsc2U7XG4gICAgICAvLyBsZXQgcGFyYW1Kc29uID0gSlNPTi5zdHJpbmdpZnkocGFyYW0pO1xuICAgICAgdGhpcy5Db25maXJtTWVhbExvZyhyZXNwLm1lYWxfaWQpXG4gICAgfSkuY2F0Y2goZXJyID0+IHtcbiAgICAgIHd4LnNob3dUb2FzdCh7dGl0bGU6ICfor7fmsYLlpLHotKUnLGljb246ICdub25lJ30pO1xuICAgICAgd3guaGlkZUxvYWRpbmcoe30pO1xuICAgIH0pO1xuICB9XG4gIC8qKlxuICAgKiDlj5Hlh7ror7fmsYLvvIzliJvlu7rorrDlvZVcbiAgICovXG4gIHB1YmxpYyBDb25maXJtTWVhbExvZyhtZWFsX2lkOm51bWJlcil7XG4gICAgbGV0IHJlcSA9IHsgbWVhbF9pZDogbWVhbF9pZCB9O1xuICAgIHdlYkFQSS5Db25maXJtTWVhbExvZyhyZXEpLnRoZW4ocmVzcCA9PiB7XG4gICAgICB3eC5oaWRlTG9hZGluZyh7fSk7XG4gICAgICB3eC5uYXZpZ2F0ZVRvKHsgdXJsOiBgLi4vLi4vaG9tZVN1Yi9wYWdlcy9tZWFsQW5hbHlzaXMvaW5kZXg/bWVhbERhdGU9JHt0aGlzLm1lYWxEYXRlfSZtZWFsVHlwZT0ke3RoaXMubWVhbFR5cGV9YH0pXG4gICAgfSkuY2F0Y2goZXJyID0+IHtcbiAgICAgIHd4LnNob3dUb2FzdCh7dGl0bGU6ICfmj5DkuqTpo5/nianorrDlvZXlpLHotKUnLGljb246ICdub25lJ30pO1xuICAgIH0pO1xuICB9XG5cbn1cblxuUGFnZShuZXcgdGV4dFNlYXJjaCgpKVxuIl19