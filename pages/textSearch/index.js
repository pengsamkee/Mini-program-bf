"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var webAPI = require("../../api/app/AppService");
var globalEnum = require("../../api/GlobalEnum");
var textCache = require("./textCache/TextCache");
var textSearch = (function () {
    function textSearch() {
        this.filterType = 0;
        this.mealType = 0;
        this.naviType = 0;
        this.mealDate = 0;
        this.data = {
            keyword: "",
            inputShowed: false,
            resultList: [],
            resultError: [],
            recentList: []
        };
    }
    textSearch.prototype.onLoad = function (options) {
        webAPI.SetAuthToken(wx.getStorageSync(globalEnum.globalKey_token));
        console.log(wx.getStorageSync(globalEnum.globalKey_token));
        var title = options.title;
        this.filterType = parseInt(options.filterType);
        this.mealType = parseInt(options.mealType);
        this.naviType = parseInt(options.naviType);
        this.mealDate = parseInt(options.mealDate);
        wx.setNavigationBarTitle({
            title: "添加" + title
        });
    };
    textSearch.prototype.onShow = function () {
        if (this.data.resultList.length === 0) {
            this.getRecentList();
        }
    };
    textSearch.prototype.getRecentList = function () {
        var recentList = textCache.getAllValue();
        console.log(recentList);
        this.setData({
            recentList: recentList
        });
    };
    textSearch.prototype.showInput = function () {
        this.setData({
            inputShowed: true
        });
    };
    textSearch.prototype.clearInput = function () {
        this.setData({
            keyword: "",
            resultError: false
        });
    };
    textSearch.prototype.inputTyping = function (event) {
        this.setData({
            resultError: false,
            keyword: event.detail.value,
        });
    };
    textSearch.prototype.performSearch = function () {
        var keyword = this.data.keyword;
        var req = { query: keyword, filter_type: this.filterType, meal_type: this.mealType };
        console.log(req);
        var that = this;
        webAPI.RetrieveTextSearch(req).then(function (resp) {
            console.log(resp);
            that.setResultList(resp);
        }).catch(function (err) { return console.log(err); });
    };
    textSearch.prototype.setResultList = function (resp) {
        var results = [];
        if (resp.result_list.length == 0) {
            this.setData({
                resultList: [],
                resultError: true
            });
        }
        else {
            for (var index in resp.result_list) {
                var item = resp.result_list[index];
                var result = {
                    foodId: item.food_id,
                    foodName: item.food_name,
                    foodType: item.food_type,
                    amount: item.amount,
                    unit: item.unit_name,
                    energy: Math.floor(item.energy / 100)
                };
                results.push(result);
            }
            this.setData({
                resultList: results,
                resultError: false
            });
        }
        console.log(this.data.resultList);
    };
    textSearch.prototype.onTextSearchResultSelect = function (event) {
        var index = event.currentTarget.dataset.textIndex;
        var foodId = this.data.resultList[index].foodId;
        var foodName = this.data.resultList[index].foodName;
        var foodType = this.data.resultList[index].foodType;
        var imageUrl = "https://dietlens-1258665547.cos.ap-shanghai.myqcloud.com/mini-app-image/defaultImage/textsearch-default-image.png";
        if (this.naviType === 0) {
            wx.showLoading({ title: "加载中...", mask: true });
            var results = [{ food_id: foodId, food_name: foodName, food_type: foodType }];
            var food = { food_id: foodId, input_type: 2, food_type: foodType, recognition_results: results };
            var foodList = [food];
            var req = { meal_id: -1, meal_type: this.mealType, meal_date: this.mealDate, food_list: foodList };
            webAPI.CreateOrUpdateMealLog(req).then(function (resp) {
                wx.hideLoading({});
                var param = {};
                param.mealId = resp.meal_id;
                param.imageUrl = imageUrl;
                param.showShareBtn = false;
                var paramJson = JSON.stringify(param);
                wx.navigateTo({
                    url: "/pages/foodDetail/index?paramJson=" + paramJson
                });
            }).catch(function (err) {
                console.log(err);
                wx.hideLoading({});
            });
        }
        else {
            var pages = getCurrentPages();
            var prevPage = pages[pages.length - 2];
            prevPage.textSearchFood = { food_id: foodId, food_name: foodName, food_type: foodType };
            wx.navigateBack({
                delta: 1
            });
        }
        textCache.setValue(this.data.resultList[index]);
    };
    textSearch.prototype.onRecentResultSelect = function (event) {
        var index = event.currentTarget.dataset.textIndex;
        var foodId = this.data.recentList[index].foodId;
        var foodName = this.data.recentList[index].foodName;
        var foodType = this.data.recentList[index].foodType;
        var imageUrl = "https://dietlens-1258665547.cos.ap-shanghai.myqcloud.com/mini-app-image/defaultImage/textsearch-default-image.png";
        if (this.naviType === 0) {
            wx.showLoading({ title: "加载中...", mask: true });
            var results = [{ food_id: foodId, food_name: foodName, food_type: foodType }];
            var food = { food_id: foodId, input_type: 2, food_type: foodType, recognition_results: results };
            var foodList = [food];
            var req = { meal_id: -1, meal_type: this.mealType, meal_date: this.mealDate, food_list: foodList };
            webAPI.CreateOrUpdateMealLog(req).then(function (resp) {
                wx.hideLoading({});
                var param = {};
                param.mealId = resp.meal_id;
                param.imageUrl = imageUrl;
                param.showShareBtn = false;
                var paramJson = JSON.stringify(param);
                wx.navigateTo({
                    url: "/pages/foodDetail/index?paramJson=" + paramJson
                });
            }).catch(function (err) {
                console.log(err);
                wx.hideLoading({});
            });
        }
        else {
            var pages = getCurrentPages();
            var prevPage = pages[pages.length - 2];
            prevPage.textSearchFood = { food_id: foodId, food_name: foodName, food_type: foodType };
            wx.navigateBack({
                delta: 1
            });
        }
        textCache.setValue(this.data.recentList[index]);
    };
    textSearch.prototype.deleteTextSearchCache = function (event) {
        textCache.clearAll();
        this.getRecentList();
    };
    return textSearch;
}());
Page(new textSearch());
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLGlEQUFtRDtBQUVuRCxpREFBa0Q7QUFDbEQsaURBQWtEO0FBY2xEO0lBQUE7UUFDUyxlQUFVLEdBQUcsQ0FBQyxDQUFDO1FBQ2YsYUFBUSxHQUFHLENBQUMsQ0FBQztRQUNiLGFBQVEsR0FBRyxDQUFDLENBQUM7UUFDYixhQUFRLEdBQUcsQ0FBQyxDQUFDO1FBRWIsU0FBSSxHQUFHO1lBQ1osT0FBTyxFQUFFLEVBQUU7WUFDWCxXQUFXLEVBQUUsS0FBSztZQUNsQixVQUFVLEVBQUUsRUFBRTtZQUNkLFdBQVcsRUFBRSxFQUFFO1lBQ2YsVUFBVSxFQUFFLEVBQUU7U0FDZixDQUFBO0lBeUxILENBQUM7SUF2TFEsMkJBQU0sR0FBYixVQUFjLE9BQVk7UUFDeEIsTUFBTSxDQUFDLFlBQVksQ0FBQyxFQUFFLENBQUMsY0FBYyxDQUFDLFVBQVUsQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDO1FBQ25FLE9BQU8sQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLGNBQWMsQ0FBQyxVQUFVLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQztRQUUzRCxJQUFJLEtBQUssR0FBRyxPQUFPLENBQUMsS0FBSyxDQUFDO1FBQzFCLElBQUksQ0FBQyxVQUFVLEdBQUcsUUFBUSxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUMvQyxJQUFJLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDM0MsSUFBSSxDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQzNDLElBQUksQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUMzQyxFQUFFLENBQUMscUJBQXFCLENBQUM7WUFDdkIsS0FBSyxFQUFFLElBQUksR0FBRyxL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LFFBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO0lBQ2xELENBQUM7SUFFTSwwQ0FBcUIsR0FBNUIsVUFBNkIsS0FBVTtRQUNyQyxTQUFTLENBQUMsUUFBUSxFQUFFLENBQUM7UUFDckIsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO0lBQ3ZCLENBQUM7SUFFSCxpQkFBQztBQUFELENBQUMsQUFyTUQsSUFxTUM7QUFFRCxJQUFJLENBQUMsSUFBSSxVQUFVLEVBQUUsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgd2ViQVBJIGZyb20gJy4uLy4uL2FwaS9hcHAvQXBwU2VydmljZSc7XG5pbXBvcnQgeyBSZXRyaWV2ZVRleHRTZWFyY2hSZXEsIFJldHJpZXZlVGV4dFNlYXJjaFJlc3AsIENyZWF0ZU9yVXBkYXRlTWVhbExvZ1JlcSwgQWRkUmVjaXBlSXRlbVJlcSwgTWVhbExvZ1Jlc3AgfSBmcm9tIFwiL2FwaS9hcHAvQXBwU2VydmljZU9ianNcIlxuaW1wb3J0ICogYXMgZ2xvYmFsRW51bSBmcm9tICcuLi8uLi9hcGkvR2xvYmFsRW51bSdcbmltcG9ydCAqIGFzIHRleHRDYWNoZSBmcm9tICcuL3RleHRDYWNoZS9UZXh0Q2FjaGUnXG5cbnR5cGUgZGF0YSA9IHtcbiAga2V5d29yZDogU3RyaW5nO1xuICByZXN1bHRMaXN0OiBSZXN1bHRbXTtcbn1cblxudHlwZSBSZXN1bHQgPSB7XG4gIGZvb2RJZDogbnVtYmVyO1xuICBkaXNwbGF5TmFtZTogU3RyaW5nO1xuICBmb29kVHlwZTogbnVtYmVyO1xuICBlbmdyeTogbnVtYmVyO1xufVxuXG5jbGFzcyB0ZXh0U2VhcmNoIHtcbiAgcHVibGljIGZpbHRlclR5cGUgPSAwOyAvLzAuYWxsIDEucmVjaXBlIDIuaW5ncmVpZGVudFxuICBwdWJsaWMgbWVhbFR5cGUgPSAwOyAvLzEuYnJlYWtmYXN0IDIubHVuY2ggMy5kaW5uZXIgNC5zbmFja1xuICBwdWJsaWMgbmF2aVR5cGUgPSAwOyAvLzAudGV4dHNlYXJjaCA9PiBkZXRhaWwgMS50ZXh0c2VhcmNoID0+IHRhZyAyLnRleHRzZWFyY2g9PiBpbmdyZWRpZW50XG4gIHB1YmxpYyBtZWFsRGF0ZSA9IDA7IC8vcHJldiBwYWdlIG11c3QgcGFzcyBtZWFsRGF0ZSB0byB0ZXh0U2VhcmNoIHBhZ2VcblxuICBwdWJsaWMgZGF0YSA9IHtcbiAgICBrZXl3b3JkOiBcIlwiLFxuICAgIGlucHV0U2hvd2VkOiBmYWxzZSxcbiAgICByZXN1bHRMaXN0OiBbXSxcbiAgICByZXN1bHRFcnJvcjogW10sXG4gICAgcmVjZW50TGlzdDogW11cbiAgfVxuXG4gIHB1YmxpYyBvbkxvYWQob3B0aW9uczogYW55KSB7XG4gICAgd2ViQVBJLlNldEF1dGhUb2tlbih3eC5nZXRTdG9yYWdlU3luYyhnbG9iYWxFbnVtLmdsb2JhbEtleV90b2tlbikpO1xuICAgIGNvbnNvbGUubG9nKHd4LmdldFN0b3JhZ2VTeW5jKGdsb2JhbEVudW0uZ2xvYmFsS2V5X3Rva2VuKSk7XG4gICAgLy8gd2ViQVBJLlNldEF1dGhUb2tlbihcImJpbWxrYnFraDUycGEwdGE3YXNnXCIpO1xuICAgIGxldCB0aXRsZSA9IG9wdGlvbnMudGl0bGU7XG4gICAgdGhpcy5maWx0ZXJUeXBlID0gcGFyc2VJbnQob3B0aW9ucy5maWx0ZXJUeXBlKTtcbiAgICB0aGlzLm1lYWxUeXBlID0gcGFyc2VJbnQob3B0aW9ucy5tZWFsVHlwZSk7XG4gICAgdGhpcy5uYXZpVHlwZSA9IHBhcnNlSW50KG9wdGlvbnMubmF2aVR5cGUpO1xuICAgIHRoaXMubWVhbERhdGUgPSBwYXJzZUludChvcHRpb25zLm1lYWxEYXRlKTtcbiAgICB3eC5zZXROYXZpZ2F0aW9uQmFyVGl0bGUoe1xuICAgICAgdGl0bGU6IFwi5re75YqgXCIgKyB0aXRsZS8v6aG16Z2i5qCH6aKY5Li66Lev55Sx5Y+C5pWwXG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgb25TaG93KCkge1xuICAgIGlmICh0aGlzLmRhdGEucmVzdWx0TGlzdC5sZW5ndGggPT09IDApe1xuICAgICAgIHRoaXMuZ2V0UmVjZW50TGlzdCgpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBnZXRSZWNlbnRMaXN0KCl7XG4gICAgbGV0IHJlY2VudExpc3QgPSB0ZXh0Q2FjaGUuZ2V0QWxsVmFsdWUoKTtcbiAgICBjb25zb2xlLmxvZyhyZWNlbnRMaXN0KTtcbiAgICAodGhpcyBhcyBhbnkpLnNldERhdGEoe1xuICAgICAgcmVjZW50TGlzdDogcmVjZW50TGlzdFxuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIHNob3dJbnB1dCgpIHtcbiAgICAodGhpcyBhcyBhbnkpLnNldERhdGEoe1xuICAgICAgaW5wdXRTaG93ZWQ6IHRydWVcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBjbGVhcklucHV0KCkge1xuICAgICh0aGlzIGFzIGFueSkuc2V0RGF0YSh7XG4gICAgICBrZXl3b3JkOiBcIlwiLFxuICAgICAgcmVzdWx0RXJyb3I6IGZhbHNlXG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgaW5wdXRUeXBpbmcoZXZlbnQ6IGFueSkge1xuICAgICh0aGlzIGFzIGFueSkuc2V0RGF0YSh7XG4gICAgICByZXN1bHRFcnJvcjogZmFsc2UsXG4gICAgICBrZXl3b3JkOiBldmVudC5kZXRhaWwudmFsdWUsXG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgcGVyZm9ybVNlYXJjaCgpIHtcbiAgICBsZXQga2V5d29yZCA9IHRoaXMuZGF0YS5rZXl3b3JkO1xuICAgIGxldCByZXEgPSB7IHF1ZXJ5OiBrZXl3b3JkLCBmaWx0ZXJfdHlwZTogdGhpcy5maWx0ZXJUeXBlLCBtZWFsX3R5cGU6IHRoaXMubWVhbFR5cGUgfTtcbiAgICBjb25zb2xlLmxvZyhyZXEpO1xuICAgIHZhciB0aGF0ID0gdGhpcztcbiAgICB3ZWJBUEkuUmV0cmlldmVUZXh0U2VhcmNoKHJlcSkudGhlbihyZXNwID0+IHtcbiAgICAgIGNvbnNvbGUubG9nKHJlc3ApO1xuICAgICAgdGhhdC5zZXRSZXN1bHRMaXN0KHJlc3ApO1xuICAgIH0pLmNhdGNoKGVyciA9PiBjb25zb2xlLmxvZyhlcnIpKTtcbiAgfVxuXG4gIHB1YmxpYyBzZXRSZXN1bHRMaXN0KHJlc3A6IFJldHJpZXZlVGV4dFNlYXJjaFJlc3ApIHtcbiAgICBsZXQgcmVzdWx0cyA9IFtdO1xuXG4gICAgaWYgKHJlc3AucmVzdWx0X2xpc3QubGVuZ3RoPT0wKSB7XG4gICAgICAodGhpcyBhcyBhbnkpLnNldERhdGEoe1xuICAgICAgICByZXN1bHRMaXN0OiBbXSxcbiAgICAgICAgcmVzdWx0RXJyb3I6IHRydWVcbiAgICAgIH0pXG4gICAgfSBlbHNlIHtcblxuICAgICAgZm9yIChsZXQgaW5kZXggaW4gcmVzcC5yZXN1bHRfbGlzdCkge1xuICAgICAgICBsZXQgaXRlbSA9IHJlc3AucmVzdWx0X2xpc3RbaW5kZXhdO1xuICAgICAgICBsZXQgcmVzdWx0ID0ge1xuICAgICAgICAgIGZvb2RJZDogaXRlbS5mb29kX2lkLFxuICAgICAgICAgIGZvb2ROYW1lOiBpdGVtLmZvb2RfbmFtZSxcbiAgICAgICAgICBmb29kVHlwZTogaXRlbS5mb29kX3R5cGUsXG4gICAgICAgICAgYW1vdW50OiBpdGVtLmFtb3VudCxcbiAgICAgICAgICB1bml0OiBpdGVtLnVuaXRfbmFtZSxcbiAgICAgICAgICBlbmVyZ3k6IE1hdGguZmxvb3IoaXRlbS5lbmVyZ3kgLyAxMDApXG4gICAgICAgIH1cbiAgICAgICAgcmVzdWx0cy5wdXNoKHJlc3VsdCk7XG4gICAgICB9XG4gICAgICAodGhpcyBhcyBhbnkpLnNldERhdGEoe1xuICAgICAgICByZXN1bHRMaXN0OiByZXN1bHRzLFxuICAgICAgICByZXN1bHRFcnJvcjogZmFsc2VcbiAgICAgIH0pO1xuICAgIH1cblxuXG4gICAgY29uc29sZS5sb2codGhpcy5kYXRhLnJlc3VsdExpc3QpO1xuICB9XG5cbiAgLyoqXG4gICAqIHRocmVlIGNhc2VcbiAgICogMS5mb29kRGlhcnkgLT4gdGV4dHNlYXJjaCAtPiBmb29kRGV0YWlsUGFnZShyZXR1cm4gaW5ncmVkaWVudC9yZWNlaXBlKVxuICAgKiAyLmltYWdlVGFnIC0+IHRleHRzZWFyY2ggLT4gaW1hZ2VUYWcocmV0dXJuIGluZ3JlZGllbnQvcmVjZWlwZSlcbiAgICogMy5mb29kRGV0YWlsIC0+IHRleHRzZWFyY2ggLT4gZm9vZERldGFpbChyZXR1cm4gaW5ncmVkaWVudClcbiAgICogY29tbW9uIHNvbHV0aW9uOiBzZXQgcHJldlBhZ2UuZGF0YS50ZXh0U2VhcmNoSXRlbVxuICAgKi9cbiAgcHVibGljIG9uVGV4dFNlYXJjaFJlc3VsdFNlbGVjdChldmVudDogYW55KSB7XG4gICAgbGV0IGluZGV4ID0gZXZlbnQuY3VycmVudFRhcmdldC5kYXRhc2V0LnRleHRJbmRleDtcbiAgICBsZXQgZm9vZElkID0gdGhpcy5kYXRhLnJlc3VsdExpc3RbaW5kZXhdLmZvb2RJZDtcbiAgICBsZXQgZm9vZE5hbWUgPSB0aGlzLmRhdGEucmVzdWx0TGlzdFtpbmRleF0uZm9vZE5hbWU7XG4gICAgbGV0IGZvb2RUeXBlID0gdGhpcy5kYXRhLnJlc3VsdExpc3RbaW5kZXhdLmZvb2RUeXBlO1xuICAgIGxldCBpbWFnZVVybCA9IFwiaHR0cHM6Ly9kaWV0bGVucy0xMjU4NjY1NTQ3LmNvcy5hcC1zaGFuZ2hhaS5teXFjbG91ZC5jb20vbWluaS1hcHAtaW1hZ2UvZGVmYXVsdEltYWdlL3RleHRzZWFyY2gtZGVmYXVsdC1pbWFnZS5wbmdcIjtcbiAgICBpZiAodGhpcy5uYXZpVHlwZSA9PT0gMCkge1xuICAgICAgLy9jcmVhdGUgbWVhbCBoZXJlXG4gICAgICB3eC5zaG93TG9hZGluZyh7IHRpdGxlOiBcIuWKoOi9veS4rS4uLlwiLCBtYXNrOiB0cnVlIH0pO1xuICAgICAgbGV0IHJlc3VsdHMgPSBbeyBmb29kX2lkOiBmb29kSWQsIGZvb2RfbmFtZTogZm9vZE5hbWUsIGZvb2RfdHlwZTogZm9vZFR5cGUgfV07XG4gICAgICBsZXQgZm9vZCA9IHsgZm9vZF9pZDogZm9vZElkLCBpbnB1dF90eXBlOiAyLCBmb29kX3R5cGU6IGZvb2RUeXBlLCByZWNvZ25pdGlvbl9yZXN1bHRzOiByZXN1bHRzIH07XG4gICAgICBsZXQgZm9vZExpc3QgPSBbZm9vZF07XG4gICAgICBsZXQgcmVxID0geyBtZWFsX2lkOiAtMSwgbWVhbF90eXBlOiB0aGlzLm1lYWxUeXBlLCBtZWFsX2RhdGU6IHRoaXMubWVhbERhdGUsIGZvb2RfbGlzdDogZm9vZExpc3QgfTtcbiAgICAgIHdlYkFQSS5DcmVhdGVPclVwZGF0ZU1lYWxMb2cocmVxKS50aGVuKHJlc3AgPT4ge1xuICAgICAgICB3eC5oaWRlTG9hZGluZyh7fSk7XG4gICAgICAgIGxldCBwYXJhbSA9IHt9O1xuICAgICAgICBwYXJhbS5tZWFsSWQgPSByZXNwLm1lYWxfaWQ7XG4gICAgICAgIHBhcmFtLmltYWdlVXJsID0gaW1hZ2VVcmw7XG4gICAgICAgIHBhcmFtLnNob3dTaGFyZUJ0biA9IGZhbHNlO1xuICAgICAgICBsZXQgcGFyYW1Kc29uID0gSlNPTi5zdHJpbmdpZnkocGFyYW0pO1xuICAgICAgICB3eC5uYXZpZ2F0ZVRvKHtcbiAgICAgICAgICB1cmw6IFwiL3BhZ2VzL2Zvb2REZXRhaWwvaW5kZXg/cGFyYW1Kc29uPVwiICsgcGFyYW1Kc29uXG4gICAgICAgIH0pO1xuICAgICAgfSkuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgY29uc29sZS5sb2coZXJyKTtcbiAgICAgICAgd3guaGlkZUxvYWRpbmcoe30pO1xuICAgICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgbGV0IHBhZ2VzID0gZ2V0Q3VycmVudFBhZ2VzKCk7XG4gICAgICBsZXQgcHJldlBhZ2UgPSBwYWdlc1twYWdlcy5sZW5ndGggLSAyXTtcbiAgICAgIC8vc2V0IHRleHQgc2VhcmNoIHJlc3VsdCB0byBwcmV2IHBhZ2VzXG4gICAgICBwcmV2UGFnZS50ZXh0U2VhcmNoRm9vZCA9IHsgZm9vZF9pZDogZm9vZElkLCBmb29kX25hbWU6IGZvb2ROYW1lLCBmb29kX3R5cGU6IGZvb2RUeXBlIH1cbiAgICAgIHd4Lm5hdmlnYXRlQmFjayh7XG4gICAgICAgIGRlbHRhOiAxXG4gICAgICB9KVxuICAgIH1cbiAgICAvL3JlY2VudCBMUlVcbiAgICB0ZXh0Q2FjaGUuc2V0VmFsdWUodGhpcy5kYXRhLnJlc3VsdExpc3RbaW5kZXhdKTtcbiAgfVxuXG4gIHB1YmxpYyBvblJlY2VudFJlc3VsdFNlbGVjdChldmVudDogYW55KXtcbiAgICBsZXQgaW5kZXggPSBldmVudC5jdXJyZW50VGFyZ2V0LmRhdGFzZXQudGV4dEluZGV4O1xuICAgIGxldCBmb29kSWQgPSB0aGlzLmRhdGEucmVjZW50TGlzdFtpbmRleF0uZm9vZElkO1xuICAgIGxldCBmb29kTmFtZSA9IHRoaXMuZGF0YS5yZWNlbnRMaXN0W2luZGV4XS5mb29kTmFtZTtcbiAgICBsZXQgZm9vZFR5cGUgPSB0aGlzLmRhdGEucmVjZW50TGlzdFtpbmRleF0uZm9vZFR5cGU7XG4gICAgbGV0IGltYWdlVXJsID0gXCJodHRwczovL2RpZXRsZW5zLTEyNTg2NjU1NDcuY29zLmFwLXNoYW5naGFpLm15cWNsb3VkLmNvbS9taW5pLWFwcC1pbWFnZS9kZWZhdWx0SW1hZ2UvdGV4dHNlYXJjaC1kZWZhdWx0LWltYWdlLnBuZ1wiO1xuICAgIGlmICh0aGlzLm5hdmlUeXBlID09PSAwKSB7XG4gICAgICAvL2NyZWF0ZSBtZWFsIGhlcmVcbiAgICAgIHd4LnNob3dMb2FkaW5nKHsgdGl0bGU6IFwi5Yqg6L295LitLi4uXCIsIG1hc2s6IHRydWUgfSk7XG4gICAgICBsZXQgcmVzdWx0cyA9IFt7IGZvb2RfaWQ6IGZvb2RJZCwgZm9vZF9uYW1lOiBmb29kTmFtZSwgZm9vZF90eXBlOiBmb29kVHlwZSB9XTtcbiAgICAgIGxldCBmb29kID0geyBmb29kX2lkOiBmb29kSWQsIGlucHV0X3R5cGU6IDIsIGZvb2RfdHlwZTogZm9vZFR5cGUsIHJlY29nbml0aW9uX3Jlc3VsdHM6IHJlc3VsdHMgfTtcbiAgICAgIGxldCBmb29kTGlzdCA9IFtmb29kXTtcbiAgICAgIGxldCByZXEgPSB7IG1lYWxfaWQ6IC0xLCBtZWFsX3R5cGU6IHRoaXMubWVhbFR5cGUsIG1lYWxfZGF0ZTogdGhpcy5tZWFsRGF0ZSwgZm9vZF9saXN0OiBmb29kTGlzdCB9O1xuICAgICAgd2ViQVBJLkNyZWF0ZU9yVXBkYXRlTWVhbExvZyhyZXEpLnRoZW4ocmVzcCA9PiB7XG4gICAgICAgIHd4LmhpZGVMb2FkaW5nKHt9KTtcbiAgICAgICAgbGV0IHBhcmFtID0ge307XG4gICAgICAgIHBhcmFtLm1lYWxJZCA9IHJlc3AubWVhbF9pZDtcbiAgICAgICAgcGFyYW0uaW1hZ2VVcmwgPSBpbWFnZVVybDtcbiAgICAgICAgcGFyYW0uc2hvd1NoYXJlQnRuID0gZmFsc2U7XG4gICAgICAgIGxldCBwYXJhbUpzb24gPSBKU09OLnN0cmluZ2lmeShwYXJhbSk7XG4gICAgICAgIHd4Lm5hdmlnYXRlVG8oe1xuICAgICAgICAgIHVybDogXCIvcGFnZXMvZm9vZERldGFpbC9pbmRleD9wYXJhbUpzb249XCIgKyBwYXJhbUpzb25cbiAgICAgICAgfSk7XG4gICAgICB9KS5jYXRjaChlcnIgPT4ge1xuICAgICAgICBjb25zb2xlLmxvZyhlcnIpO1xuICAgICAgICB3eC5oaWRlTG9hZGluZyh7fSk7XG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgbGV0IHBhZ2VzID0gZ2V0Q3VycmVudFBhZ2VzKCk7XG4gICAgICBsZXQgcHJldlBhZ2UgPSBwYWdlc1twYWdlcy5sZW5ndGggLSAyXTtcbiAgICAgIC8vc2V0IHRleHQgc2VhcmNoIHJlc3VsdCB0byBwcmV2IHBhZ2VzXG4gICAgICBwcmV2UGFnZS50ZXh0U2VhcmNoRm9vZCA9IHsgZm9vZF9pZDogZm9vZElkLCBmb29kX25hbWU6IGZvb2ROYW1lLCBmb29kX3R5cGU6IGZvb2RUeXBlIH1cbiAgICAgIHd4Lm5hdmlnYXRlQmFjayh7XG4gICAgICAgIGRlbHRhOiAxXG4gICAgICB9KVxuICAgIH1cbiAgICAvL3JlY2VudCBMUlVcbiAgICB0ZXh0Q2FjaGUuc2V0VmFsdWUodGhpcy5kYXRhLnJlY2VudExpc3RbaW5kZXhdKTtcbiAgfVxuXG4gIHB1YmxpYyBkZWxldGVUZXh0U2VhcmNoQ2FjaGUoZXZlbnQ6IGFueSl7XG4gICAgdGV4dENhY2hlLmNsZWFyQWxsKCk7XG4gICAgdGhpcy5nZXRSZWNlbnRMaXN0KCk7XG4gIH1cblxufVxuXG5QYWdlKG5ldyB0ZXh0U2VhcmNoKCkpXG4iXX0=